{% extends 'base.html' %}

{% block title %}Asistente IA - Sistema PESCO{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="bi bi-robot me-2"></i>
            Asistente IA
        </h1>
        <p class="text-muted mb-0">
            Pega el contenido del correo, adjunta un pantallazo de SAP o un archivo Excel con c√≥digos masivos (75+).
        </p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
                <label for="mensaje" class="form-label">
                    Texto del correo / instrucciones
                </label>
                <textarea id="mensaje" name="mensaje" rows="5" class="form-control"
                    placeholder="Ejemplo: 'Procesa esta solicitud de PC 2510545 para SUCURSAL CALAMA, te adjunto el archivo con los c√≥digos'">{{ request.POST.mensaje }}</textarea>
                <small class="text-muted">
                    Puedes pegar aqu√≠ el contenido del correo o un resumen.
                </small>
            </div>

            <div class="mb-3">
                <label for="imagen" class="form-label">
                    Pantallazo SAP (opcional)
                </label>
                <input type="file" id="imagen" name="imagen" class="form-control" accept="image/*">
                <small class="text-muted">
                    Si adjuntas una imagen, la IA intentar√° leer c√≥digos y cantidades desde el pantallazo.
                </small>
            </div>

            <div class="mb-3">
                <label for="excel" class="form-label">
                    üìä Archivo Excel con c√≥digos (opcional)
                </label>
                <input type="file" id="excel" name="excel" class="form-control" accept=".xlsx,.xls">
                <small class="text-muted">
                    <strong>NUEVO:</strong> Para pedidos con muchos c√≥digos (75+), adjunta un Excel simple con columnas:
                    <code>C√≥digo | Cantidad</code>.
                    La IA extraer√° la metadata del texto (tipo, n√∫mero, cliente) y los productos del Excel.
                    <ul>
                        <li><strong>C√≥digo</strong> (opcional si hay descripci√≥n)</li>
                        <li><strong>Descripci√≥n</strong> (opcional si hay c√≥digo)</li>
                        <li><strong>Cantidad</strong> (obligatorio)</li>
                        <li><strong>Bodega</strong> (opcional, ej: 013-01)</li>
                    </ul>
                    <p class="mb-0">
                        Si no indicas bodega, el sistema intentar√° asignarla autom√°ticamente seg√∫n el stock disponible.
                    </p>
                </small>
            </div>

            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="sin_validacion_stock" name="sin_validacion_stock" value="1">
                    <label class="form-check-label" for="sin_validacion_stock">
                        <strong>üîì Sin validaci√≥n de stock</strong>
                    </label>
                </div>
                <small class="text-muted">
                    Activa esta opci√≥n para c√≥digos de <strong>exportaci√≥n, traslados o productos que no pasan por el inventario</strong>.
                    Los c√≥digos se asignar√°n autom√°ticamente a bodega <strong>013</strong> (Despacho) sin validar stock.
                </small>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-magic me-2"></i>
                    Procesar con IA y crear solicitud
                </button>
            </div>
        </form>
    </div>
</div>

{% if payload %}
<div class="card">
    <div class="card-header">
        <strong>Payload IA (previo a crear solicitud)</strong>
    </div>
    <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap;">{{ payload|safe|json_script:"ia-payload" }}</pre>
    </div>
</div>
{% endif %}

<!-- Loading Spinner -->
<div id="loadingSpinner" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center">
                <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-light mt-3 fs-5" id="loadingMessage">Procesando...</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const loadingSpinner = new bootstrap.Modal(document.getElementById('loadingSpinner'));
        const loadingMessage = document.getElementById('loadingMessage');

        if (form) {
            form.addEventListener('submit', function (e) {
                const texto = document.getElementById('mensaje').value.trim();
                const imagen = document.getElementById('imagen').files.length > 0;
                const excel = document.getElementById('excel').files.length > 0;

                if (texto || imagen || excel) {
                    // Determinar mensaje seg√∫n lo que se est√° procesando
                    if (excel) {
                        loadingMessage.textContent = 'üìä Procesando archivo Excel...';
                    } else if (imagen) {
                        loadingMessage.textContent = 'üñºÔ∏è Analizando imagen con IA...';
                    } else {
                        loadingMessage.textContent = 'ü§ñ Procesando con IA...';
                    }

                    // Mostrar spinner
                    loadingSpinner.show();
                }
            });
        }
    });
</script>

{% endblock %}