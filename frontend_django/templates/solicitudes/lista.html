{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitudes - Sistema PESCO{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Solicitudes</h1>
            <p class="text-muted mb-0">Gesti√≥n y seguimiento de solicitudes.</p>
        </div>
        <div>
            <a href="." class="btn btn-light border shadow-sm">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </a>
        </div>
    </div>

    <!-- Filtros y B√∫squeda -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" name="q" class="form-control border-start-0"
                            placeholder="Buscar por ID, cliente, pedido..." value="{{ busqueda }}">
                    </div>
                </div>
                <div class="col-md-2">
                    <select name="estado" class="form-select">
                        <option value="">Todos los estados</option>
                        {% for estado_conf in estados_config %}
                        <option value="{{ estado_conf.slug }}" {% if estado == estado_conf.slug %}selected{% endif %}>
                            {{ estado_conf.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="tipo" class="form-select">
                        <option value="">Todos los tipos</option>
                        <option value="VENTA" {% if tipo == 'VENTA' %}selected{% endif %}>Venta</option>
                        <option value="ORDEN_FABRICACION" {% if tipo == 'ORDEN_FABRICACION' %}selected{% endif %}>Orden de
                            Fabricaci√≥n</option>
                        <option value="TRANSFERENCIA" {% if tipo == 'TRANSFERENCIA' %}selected{% endif %}>Transferencia
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="urgente" class="form-select">
                        <option value="">Todas las prioridades</option>
                        <option value="1" {% if urgente == '1' %}selected{% endif %}>S√≥lo urgentes</option>
                        <option value="0" {% if urgente == '0' %}selected{% endif %}>S√≥lo normales</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-1"></i> Filtrar
                    </button>
                    {% if busqueda or estado or tipo or urgente %}
                    <a href="." class="btn btn-outline-secondary w-100 mt-2">
                        <i class="bi bi-x-circle me-1"></i> Limpiar
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Resultados -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-uppercase text-muted small fw-bold">
                        <tr>
                            <th class="ps-4 py-3">ID</th>
                            <th class="py-3">Fecha / Hora</th>
                            <th class="py-3">Tipo</th>
                            <th class="py-3">N√∫mero</th>
                            <th class="py-3">Cliente</th>
                            <th class="py-3">Estado</th>
                            <th class="py-3">Bultos</th>
                            <th class="py-3">Transporte</th>
                            <th class="pe-4 py-3 text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in page_obj %}
                        <tr>
                            <td class="ps-4 fw-bold text-dark">#{{ solicitud.id }}</td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-medium">{{ solicitud.fecha_solicitud|date:"d/m/Y" }}</span>
                                    <span class="text-muted small">{{ solicitud.hora_solicitud|time:"H:i" }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary px-2 py-1" style="border-radius: 4px;">
                                    {{ solicitud.get_tipo_display }}
                                </span>
                            </td>
                            <td>
                                {% if solicitud.tipo == 'ST' and solicitud.numero_st %}
                                    <code class="text-primary">{{ solicitud.numero_st }}</code>
                                {% elif solicitud.numero_pedido %}
                                    <code class="text-dark">{{ solicitud.numero_pedido }}</code>
                                {% else %}
                                    <span class="text-muted small">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-medium">{{ solicitud.cliente|truncatewords:5 }}</span>
                            </td>
                            <td>
                                <span class="badge bg-{{ solicitud.color_estado }} px-3 py-2"
                                    style="border-radius: 4px;">
                                    {{ solicitud.get_estado_display }}
                                </span>
                            </td>
                            <td>
                                {% with bultos=solicitud.bultos.all %}
                                {% if bultos %}
                                    {% for bulto in bultos %}
                                    <a href="{% url 'despacho:detalle_bulto' bulto.id %}" class="badge bg-primary text-decoration-none me-1" title="{{ bulto.codigo }}">
                                        <i class="bi bi-box-seam me-1"></i>{{ forloop.counter }}
                                    </a>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted small">Sin bultos</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-truck text-muted me-2"></i>
                                    <span class="small">{{ solicitud.get_transporte_display }}</span>
                                </div>
                            </td>
                            <td class="pe-4 text-end">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-light text-primary"
                                        onclick="verDetalleSolicitud('{{ solicitud.id }}')" title="Vista r√°pida">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a href="{% url 'solicitudes:detalle' solicitud.id %}"
                                        class="btn btn-sm btn-light text-secondary" title="Ver detalle completo">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    {% if es_admin %}
                                    <a href="{% url 'solicitudes:editar' solicitud.id %}"
                                        class="btn btn-sm btn-light text-warning" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-inbox display-4 mb-3 d-block opacity-50"></i>
                                    <p class="h5">No se encontraron solicitudes</p>
                                    <p class="small">Intenta ajustar los filtros de b√∫squeda.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer de la tabla con paginaci√≥n -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer bg-white border-top-0 py-3">
            <nav aria-label="Paginaci√≥n">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link border-0 text-secondary"
                            href="?page={{ page_obj.previous_page_number }}&estado={{ estado }}&tipo={{ tipo }}&urgente={{ urgente }}&q={{ busqueda }}">
                            <i class="bi bi-chevron-left me-1"></i> Anterior
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link border-0 text-muted"><i class="bi bi-chevron-left me-1"></i>
                            Anterior</span>
                    </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link border-0 text-dark fw-bold">
                            P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link border-0 text-secondary"
                            href="?page={{ page_obj.next_page_number }}&estado={{ estado }}&tipo={{ tipo }}&urgente={{ urgente }}&q={{ busqueda }}">
                            Siguiente <i class="bi bi-chevron-right ms-1"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link border-0 text-muted">Siguiente <i
                                class="bi bi-chevron-right ms-1"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Modal de Vista R√°pida -->
    <div class="modal fade" id="modalDetalleSolicitud" tabindex="-1" aria-labelledby="modalDetalleLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="modalDetalleLabel">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <span id="modalTitulo">Solicitud</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="modalContenido">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    {% if es_admin %}
                    <div class="me-auto">
                        <a href="#" id="btnEditarSolicitud" class="btn btn-primary">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </a>
                        <div class="btn-group ms-2">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-gear me-1"></i>Acciones
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="cambiarEstadoModal(); return false;">
                                    <i class="bi bi-arrow-repeat me-2"></i>Cambiar Estado
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="toggleAfectaStockModal(); return false;">
                                    <i class="bi bi-box me-2"></i><span id="textoAfectaStock">Gestionar Stock</span>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-success" href="#" onclick="marcarDespachadoModal(); return false;">
                                    <i class="bi bi-check-circle me-2"></i>Marcar como Despachado
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    <a href="#" id="btnVerCompleto" class="btn btn-primary" target="_blank">
                        <i class="bi bi-box-arrow-up-right me-2"></i>Ver detalle completo
                    </a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuraci√≥n para JavaScript -->
    <div id="appConfig" style="display:none;"
         data-detalle-ajax-url="{% url 'solicitudes:detalle_ajax' 0 %}"
         data-detalle-completo-url="{% url 'solicitudes:detalle' 0 %}"
         data-editar-url="{% url 'solicitudes:editar' 0 %}"
         data-cambiar-estado-url="{% url 'solicitudes:cambiar_estado' 0 %}"
         data-cambiar-afecta-stock-url="{% url 'solicitudes:cambiar_afecta_stock' 0 %}"
         data-csrf-token="{{ csrf_token }}"
         data-es-admin="{% if es_admin %}true{% else %}false{% endif %}">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Leer configuraci√≥n desde el DOM
    const appConfig = document.getElementById('appConfig');
    const detalleAjaxBaseUrl = appConfig.dataset.detalleAjaxUrl;
    const detalleCompletoBaseUrl = appConfig.dataset.detalleCompletoUrl;
    const editarBaseUrl = appConfig.dataset.editarUrl;
    const cambiarEstadoBaseUrl = appConfig.dataset.cambiarEstadoUrl;
    const cambiarAfectaStockBaseUrl = appConfig.dataset.cambiarAfectaStockUrl;
    const csrfToken = appConfig.dataset.csrfToken;
    const esAdmin = appConfig.dataset.esAdmin === 'true';
    
    let solicitudActual = null;

    function verDetalleSolicitud(solicitudId) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalleSolicitud'));
        const modalContenido = document.getElementById('modalContenido');
        const modalTitulo = document.getElementById('modalTitulo');
        const btnVerCompleto = document.getElementById('btnVerCompleto');

        // Mostrar loading
        modalContenido.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';

        // Actualizar links
        btnVerCompleto.href = detalleCompletoBaseUrl.replace('0/', solicitudId + '/');
        
        if (esAdmin) {
            const btnEditarSolicitud = document.getElementById('btnEditarSolicitud');
            if (btnEditarSolicitud) {
                btnEditarSolicitud.href = editarBaseUrl.replace('0/', solicitudId + '/');
            }
        }

        // Abrir modal
        modal.show();

        // Cargar datos via AJAX
        const ajaxUrl = detalleAjaxBaseUrl.replace('0/', solicitudId + '/');
        fetch(ajaxUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar la solicitud');
                }
                return response.json();
            })
            .then(data => {
                solicitudActual = data;
                actualizarModalContenido(data, modalTitulo, modalContenido);
            })
            .catch(error => {
                modalContenido.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error al cargar los detalles de la solicitud.</div>';
                console.error('Error:', error);
            });
    }

    function actualizarModalContenido(data, modalTitulo, modalContenido) {
        // Actualizar t√≠tulo
        let tituloHtml = 'Solicitud #' + data.id + ' <span class="badge bg-' + data.color_estado + '">' + data.estado + '</span>';
        
        if (data.urgente) {
            tituloHtml += '<span class="badge bg-danger ms-2"><i class="bi bi-exclamation-triangle me-1"></i>Urgente</span>';
        }
        
        if (data.afecta_stock === false) {
            tituloHtml += '<span class="badge bg-info text-dark ms-2" title="No afecta stock"><i class="bi bi-info-circle me-1"></i>Sin afectar stock</span>';
        }
        
        modalTitulo.innerHTML = tituloHtml;

        // Generar HTML de productos
        let productosHtml = '';
        data.productos.forEach(function(prod) {
            let rowClass = prod.bulto_id ? '' : 'table-warning';
            let bultoInfo = prod.bulto_id ? '<a href="/despacho/bultos/' + prod.bulto_id + '/" target="_blank" class="badge bg-primary text-decoration-none"><i class="bi bi-box-seam me-1"></i>' + prod.bulto_codigo + '</a>' : '<span class="badge bg-warning text-dark">Pendiente</span>';
            
            productosHtml += '<tr class="' + rowClass + '">';
            productosHtml += '<td><code>' + prod.codigo + '</code></td>';
            productosHtml += '<td>' + prod.descripcion + '</td>';
            productosHtml += '<td>' + prod.cantidad + '</td>';
            productosHtml += '<td>' + prod.estado_bodega + '</td>';
            productosHtml += '<td>' + bultoInfo + '</td>';
            productosHtml += '</tr>';
        });

        // Actualizar contenido
        var contenidoHtml = '<div class="row">';
        contenidoHtml += '<div class="col-md-6">';
        contenidoHtml += '<h6 class="border-bottom pb-2 mb-3">Informaci√≥n General</h6>';
        contenidoHtml += '<dl class="row">';
        contenidoHtml += '<dt class="col-sm-5">Fecha:</dt><dd class="col-sm-7">' + data.fecha + ' - ' + data.hora + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">Tipo:</dt><dd class="col-sm-7">' + data.tipo + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">N¬∞ Pedido / OF:</dt><dd class="col-sm-7">' + data.numero_pedido + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">N¬∞ ST:</dt><dd class="col-sm-7">' + data.numero_st + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">N¬∞ OT:</dt><dd class="col-sm-7">' + data.numero_ot + '</dd>';
        if (data.numero_guia_despacho) {
            contenidoHtml += '<dt class="col-sm-5">Gu√≠a/Factura:</dt><dd class="col-sm-7"><span class="badge bg-success">' + data.numero_guia_despacho + '</span></dd>';
        }
        contenidoHtml += '<dt class="col-sm-5">Cliente:</dt><dd class="col-sm-7"><strong>' + data.cliente + '</strong></dd>';
        contenidoHtml += '<dt class="col-sm-5">Bodega:</dt><dd class="col-sm-7">' + data.bodega + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">Transporte:</dt><dd class="col-sm-7">' + data.transporte + '</dd>';
        contenidoHtml += '</dl></div>';
        
        contenidoHtml += '<div class="col-md-6">';
        contenidoHtml += '<h6 class="border-bottom pb-2 mb-3">Descripci√≥n</h6>';
        contenidoHtml += '<p class="text-muted small">' + data.descripcion + '</p>';
        contenidoHtml += '<h6 class="border-bottom pb-2 mb-3 mt-4">Observaciones</h6>';
        contenidoHtml += '<p class="text-muted small">' + data.observacion + '</p>';
        contenidoHtml += '<h6 class="border-bottom pb-2 mb-3 mt-4">Metadatos</h6>';
        contenidoHtml += '<dl class="row small">';
        contenidoHtml += '<dt class="col-sm-5">Solicitante:</dt><dd class="col-sm-7">' + data.solicitante + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">Creado:</dt><dd class="col-sm-7">' + data.created_at + '</dd>';
        contenidoHtml += '<dt class="col-sm-5">Actualizado:</dt><dd class="col-sm-7">' + data.updated_at + '</dd>';
        contenidoHtml += '</dl></div></div>';
        
        // Informaci√≥n de bultos
        var bultosHtml = '';
        if (data.bultos && data.bultos.length > 0) {
            contenidoHtml += '<div class="row mt-4"><div class="col-12">';
            contenidoHtml += '<h6 class="border-bottom pb-2 mb-3">Bultos Asociados (' + data.bultos.length + ')</h6>';
            
            data.bultos.forEach(function(bulto) {
                contenidoHtml += '<div class="card mb-3 border-primary">';
                contenidoHtml += '<div class="card-header bg-primary text-white py-2">';
                contenidoHtml += '<strong><i class="bi bi-box-seam me-2"></i>' + bulto.codigo + '</strong>';
                contenidoHtml += '<span class="ms-3 badge bg-light text-dark">' + bulto.estado + '</span>';
                contenidoHtml += '<a href="/despacho/bultos/' + bulto.id + '/" target="_blank" class="btn btn-sm btn-light float-end"><i class="bi bi-box-arrow-up-right"></i></a>';
                contenidoHtml += '</div>';
                contenidoHtml += '<div class="card-body p-2">';
                contenidoHtml += '<div class="row g-2">';
                contenidoHtml += '<div class="col-md-6"><small class="text-muted">Tipo:</small> <strong>' + bulto.tipo + '</strong></div>';
                contenidoHtml += '<div class="col-md-6"><small class="text-muted">Transportista:</small> <strong>' + bulto.transportista + '</strong></div>';
                contenidoHtml += '<div class="col-md-3"><small class="text-muted">Peso:</small> <strong>' + bulto.peso + ' kg</strong></div>';
                contenidoHtml += '<div class="col-md-3"><small class="text-muted">Largo:</small> <strong>' + bulto.largo + ' cm</strong></div>';
                contenidoHtml += '<div class="col-md-3"><small class="text-muted">Ancho:</small> <strong>' + bulto.ancho + ' cm</strong></div>';
                contenidoHtml += '<div class="col-md-3"><small class="text-muted">Alto:</small> <strong>' + bulto.alto + ' cm</strong></div>';
                contenidoHtml += '<div class="col-md-12"><small class="text-muted">C√≥digos en bulto:</small> <span class="badge bg-secondary">' + bulto.codigos.length + '</span>';
                bulto.codigos.forEach(function(cod) {
                    contenidoHtml += ' <code class="ms-1">' + cod + '</code>';
                });
                contenidoHtml += '</div>';
                contenidoHtml += '</div></div></div>';
            });
            
            contenidoHtml += '</div></div>';
        }
        
        contenidoHtml += '<div class="row mt-4"><div class="col-12">';
        var pendientes = data.productos.filter(function(p) { return !p.bulto_id; }).length;
        var enBultos = data.productos.filter(function(p) { return p.bulto_id; }).length;
        contenidoHtml += '<h6 class="border-bottom pb-2 mb-3">Productos (' + data.productos.length + ' total';
        if (enBultos > 0) contenidoHtml += ' - <span class="text-success">' + enBultos + ' en bultos</span>';
        if (pendientes > 0) contenidoHtml += ' - <span class="text-warning">' + pendientes + ' pendientes</span>';
        contenidoHtml += ')</h6>';
        contenidoHtml += '<div class="table-responsive"><table class="table table-sm table-hover">';
        contenidoHtml += '<thead class="table-light"><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Cantidad</th><th>Estado</th><th>Bulto</th></tr></thead>';
        contenidoHtml += '<tbody>' + productosHtml + '</tbody>';
        contenidoHtml += '</table></div></div></div>';
        
        modalContenido.innerHTML = contenidoHtml;
    }
    
    // Funciones de admin (siempre definidas para evitar errores de undefined)
    function cambiarEstadoModal() {
        if (!esAdmin) {
            Swal.fire('Error', 'No tienes permisos para realizar esta acci√≥n', 'error');
            return;
        }
        if (!solicitudActual) return;
        
        const estados = [
            { value: 'pendiente', label: 'Pendiente' },
            { value: 'en_despacho', label: 'En Despacho' },
            { value: 'embalado', label: 'Embalado' },
            { value: 'listo_despacho', label: 'Listo para Despacho' },
            { value: 'en_ruta', label: 'En Ruta' },
            { value: 'despachado', label: 'Despachado' },
            { value: 'cancelado', label: 'Cancelado' }
        ];
        
        let opciones = estados.map(function(e) {
            return '<option value="' + e.value + '">' + e.label + '</option>';
        }).join('');
        
        Swal.fire({
            title: 'Cambiar Estado',
            html: '<select id="nuevoEstado" class="form-select">' + opciones + '</select>',
            showCancelButton: true,
            confirmButtonText: 'Cambiar',
            cancelButtonText: 'Cancelar',
            preConfirm: function() {
                return document.getElementById('nuevoEstado').value;
            }
        }).then(function(result) {
            if (result.isConfirmed) {
                const nuevoEstado = result.value;
                
                if (nuevoEstado === 'despachado') {
                    Swal.fire({
                        title: '¬øEst√°s seguro?',
                        text: 'Al marcar como despachado se descontar√° el stock de bodega 013',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, despachar',
                        cancelButtonText: 'Cancelar'
                    }).then(function(confirmResult) {
                        if (confirmResult.isConfirmed) {
                            ejecutarCambioEstadoModal(nuevoEstado);
                        }
                    });
                } else {
                    ejecutarCambioEstadoModal(nuevoEstado);
                }
            }
        });
    }

    function ejecutarCambioEstadoModal(nuevoEstado) {
        if (!solicitudActual) return;
        
        const url = cambiarEstadoBaseUrl.replace('0/', solicitudActual.id + '/');
        
        console.log('Cambiando estado a:', nuevoEstado, 'para solicitud:', solicitudActual.id);
        console.log('URL:', url);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'estado=' + nuevoEstado
        })
        .then(function(response) {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(function(data) {
            console.log('Response data:', data);
            if (data.success) {
                let mensaje = data.message;
                if (data.descuento) {
                    mensaje += '\n\nDetalles del descuento:\n';
                    if (data.descuento.detalles) {
                        data.descuento.detalles.forEach(function(det) {
                            mensaje += '\n‚Ä¢ ' + det.codigo + ': ' + det.stock_anterior + ' ‚Üí ' + det.stock_nuevo;
                        });
                    }
                }
                Swal.fire({
                    title: '¬°√âxito!',
                    html: mensaje.replace(/\n/g, '<br>'),
                    icon: data.warning ? 'warning' : 'success'
                }).then(function() {
                    location.reload();
                });
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        })
        .catch(function(error) {
            console.error('Error en fetch:', error);
            Swal.fire('Error', 'Hubo un problema al cambiar el estado: ' + error, 'error');
        });
    }

    function marcarDespachadoModal() {
        console.log('üîî marcarDespachadoModal() llamado');
        console.log('   esAdmin:', esAdmin);
        console.log('   solicitudActual:', solicitudActual);
        
        if (!esAdmin) {
            console.error('‚ùå Usuario no es admin');
            Swal.fire('Error', 'No tienes permisos para realizar esta acci√≥n', 'error');
            return;
        }
        if (!solicitudActual) {
            console.error('‚ùå No hay solicitud actual');
            return;
        }
        
        console.log('‚úÖ Mostrando modal de confirmaci√≥n para solicitud #' + solicitudActual.id);
        
        Swal.fire({
            title: 'Confirmar Despacho',
            html: '<div class="text-start">' +
                  '<p class="mb-3">Se descontar√° el stock de bodega 013 para todos los productos que est√©n en bultos.</p>' +
                  '<p class="mb-3"><strong>Esta acci√≥n confirma la salida definitiva de la mercanc√≠a.</strong></p>' +
                  '<div class="mb-3">' +
                  '<label for="numeroGuiaDespacho" class="form-label">N√∫mero de Gu√≠a/Factura:</label>' +
                  '<input type="text" id="numeroGuiaDespacho" class="form-control" placeholder="Ej: 12345678" value="' + (solicitudActual.numero_guia_despacho || '') + '">' +
                  '<small class="text-muted">Ingresa el n√∫mero de gu√≠a o factura que confirma el despacho</small>' +
                  '</div>' +
                  '</div>',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'S√≠, despachar',
            confirmButtonColor: '#28a745',
            cancelButtonText: 'Cancelar',
            preConfirm: function() {
                const guia = document.getElementById('numeroGuiaDespacho').value;
                console.log('üìù Gu√≠a ingresada:', guia);
                return guia;
            }
        }).then(function(result) {
            console.log('Modal result:', result);
            if (result.isConfirmed) {
                const numeroGuia = result.value;
                console.log('‚úÖ Confirmado. Ejecutando despacho con gu√≠a:', numeroGuia);
                ejecutarDespachoConGuia('despachado', numeroGuia);
            } else {
                console.log('‚ùå Usuario cancel√≥');
            }
        });
    }
    
    function ejecutarDespachoConGuia(nuevoEstado, numeroGuia) {
        console.log('\n' + '='.repeat(60));
        console.log('üöÄ ejecutarDespachoConGuia()');
        console.log('='.repeat(60));
        console.log('Solicitud ID:', solicitudActual ? solicitudActual.id : 'N/A');
        console.log('Nuevo estado:', nuevoEstado);
        console.log('N√∫mero gu√≠a:', numeroGuia);
        
        if (!solicitudActual) {
            console.error('‚ùå No hay solicitud actual');
            return;
        }
        
        const url = cambiarEstadoBaseUrl.replace('0/', solicitudActual.id + '/');
        const body = 'estado=' + nuevoEstado + '&numero_guia_despacho=' + encodeURIComponent(numeroGuia);
        
        console.log('URL:', url);
        console.log('Body:', body);
        console.log('CSRF Token:', csrfToken);
        console.log('\nüì° Enviando petici√≥n...\n');
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: body
        })
        .then(function(response) {
            console.log('üì• Response status:', response.status);
            console.log('Response ok:', response.ok);
            return response.json();
        })
        .then(function(data) {
            console.log('üì¶ Response data:', data);
            console.log('='.repeat(60) + '\n');
            
            if (data.success) {
                let mensaje = data.message;
                console.log('‚úÖ √âxito:', mensaje);
                Swal.fire('¬°√âxito!', mensaje, 'success').then(function() {
                    console.log('üîÑ Recargando p√°gina...');
                    location.reload();
                });
            } else {
                console.error('‚ùå Error:', data.message);
                Swal.fire('Error', data.message, 'error');
            }
        })
        .catch(function(error) {
            console.error('‚ùå Error en fetch:', error);
            console.log('='.repeat(60) + '\n');
            Swal.fire('Error', 'Hubo un problema al cambiar el estado: ' + error, 'error');
        });
    }

    function toggleAfectaStockModal() {
        if (!esAdmin) {
            Swal.fire('Error', 'No tienes permisos para realizar esta acci√≥n', 'error');
            return;
        }
        if (!solicitudActual) return;
        
        const afectaActual = solicitudActual.afecta_stock !== false;
        const nuevoValor = !afectaActual;
        
        Swal.fire({
            title: nuevoValor ? '¬øActivar afectaci√≥n de stock?' : '¬øDesactivar afectaci√≥n de stock?',
            text: nuevoValor ? 'La solicitud volver√° a afectar stock normalmente' : 'La solicitud NO afectar√° stock (√≥rdenes especiales, traslados, etc.)',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'S√≠, cambiar',
            cancelButtonText: 'Cancelar'
        }).then(function(result) {
            if (result.isConfirmed) {
                const url = cambiarAfectaStockBaseUrl.replace('0/', solicitudActual.id + '/');
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'afecta_stock=' + nuevoValor
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        Swal.fire('¬°√âxito!', data.message, 'success').then(function() {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                });
            }
        });
    }
</script>
{% endblock %}