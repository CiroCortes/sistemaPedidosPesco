{% extends 'base.html' %}

{% block title %}{% if es_edicion %}Editar{% else %}Nueva{% endif %} Solicitud - Sistema PESCO{% endblock %}

{% block extra_css %}
<style>
.stock-info-row {
    background-color: #f8f9fa;
}
.stock-info-row td {
    padding: 0.25rem 0.5rem !important;
}
.alert-sm {
    font-size: 0.875rem;
    line-height: 1.4;
}
input[readonly] {
    background-color: #e9ecef !important;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="bi bi-{% if es_edicion %}pencil{% else %}file-earmark-plus{% endif %} me-2"></i>
            {% if es_edicion %}Editar Solicitud #{{ solicitud.id }}{% else %}Nueva Solicitud{% endif %}
        </h1>
        <p class="text-muted mb-0">Formulario de ingreso manual para el equipo administrativo.</p>
    </div>
    <a href="{% url 'solicitudes:lista' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Volver al listado
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" novalidate id="formSolicitud">
            {% csrf_token %}

            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">{{ form.tipo.label }}</label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                        <div class="text-danger small mt-1">{{ form.tipo.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_pedido.label }}</label>
                    {{ form.numero_pedido }}
                    <small class="text-muted">OF o n√∫mero manual</small>
                    {% if form.numero_pedido.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_pedido.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_ot.label }}</label>
                    {{ form.numero_ot }}
                    <small class="text-muted">Orden de transporte (OT) si aplica.</small>
                    {% if form.numero_ot.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_ot.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% if es_edicion %}
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_guia_despacho.label }}</label>
                    {{ form.numero_guia_despacho }}
                    <small class="text-muted">Gu√≠a o factura del despacho.</small>
                    {% if form.numero_guia_despacho.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_guia_despacho.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="col-md-12">
                    <label class="form-label">{{ form.cliente.label }}</label>
                    {{ form.cliente }}
                    {% if form.cliente.errors %}
                        <div class="text-danger small mt-1">{{ form.cliente.errors|striptags }}</div>
                    {% endif %}
                </div>

                <div class="{% if es_edicion %}col-md-6{% else %}col-md-12{% endif %}">
                    <label class="form-label">Transporte</label>
                    <select name="{{ form.transporte.name }}" class="form-select" id="id_{{ form.transporte.name }}">
                        {% for value, label in form.transporte.field.choices %}
                        <option value="{{ value }}" {% if form.transporte.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.transporte.errors %}
                        <div class="text-danger small mt-1">{{ form.transporte.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% if es_edicion %}
                <div class="col-md-6">
                    <label class="form-label">Estado</label>
                    <select name="{{ form.estado.name }}" class="form-select" id="id_{{ form.estado.name }}">
                        {% for value, label in form.estado.field.choices %}
                        <option value="{{ value }}" {% if form.estado.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.estado.errors %}
                        <div class="text-danger small mt-1">{{ form.estado.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="col-md-6 d-flex align-items-center mt-4">
                    <div class="form-check form-switch">
                        {{ form.urgente }}
                        <label class="form-check-label ms-2">{{ form.urgente.label }}</label>
                    </div>
                    {% if form.urgente.errors %}
                        <div class="text-danger small ms-3">{{ form.urgente.errors|striptags }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 d-flex align-items-center mt-4">
                    <div class="form-check form-switch">
                        {{ form.afecta_stock }}
                        <label class="form-check-label ms-2">{{ form.afecta_stock.label }}</label>
                    </div>
                    <small class="text-muted d-block ms-3">Desmarcar para √≥rdenes especiales</small>
                    {% if form.afecta_stock.errors %}
                        <div class="text-danger small ms-3">{{ form.afecta_stock.errors|striptags }}</div>
                    {% endif %}
                </div>

                <div class="col-md-12">
                    <label class="form-label">{{ form.observacion.label }}</label>
                    {{ form.observacion }}
                    {% if form.observacion.errors %}
                        <div class="text-danger small mt-1">{{ form.observacion.errors|striptags }}</div>
                    {% endif %}
                </div>

            </div>

            <!-- Detalles adicionales -->
            {% if not es_edicion_avanzada %}
            <hr class="my-4">
            <h5>Productos adicionales</h5>
            <p class="text-muted">
                <i class="bi bi-info-circle me-1"></i> 
                Ingresa cada c√≥digo y selecciona de qu√© <strong>bodega</strong> se preparar√°. 
                M√∫ltiples usuarios de bodega ver√°n esta solicitud y entregar√°n los materiales desde su bodega asignada.
            </p>

            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th style="width: 150px;">C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th style="width: 200px;">Bodega</th>
                            <th style="width: 100px;">Cantidad</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="detalle-rows">
                        {{ formset.management_form }}
                        {% for f in formset %}
                        <tr>
                            <td>
                                {{ f.codigo }}
                                {{ f.id }}
                                {% if f.codigo.errors %}
                                    <div class="text-danger small">{{ f.codigo.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.descripcion }}
                                {% if f.descripcion.errors %}
                                    <div class="text-danger small">{{ f.descripcion.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.bodega }}
                                {% if f.bodega.errors %}
                                    <div class="text-danger small">{{ f.bodega.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.cantidad }}
                                {% if f.cantidad.errors %}
                                    <div class="text-danger small">{{ f.cantidad.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if f.DELETE %}
                                    <div class="form-check">
                                        {{ f.DELETE }}
                                        <label class="form-check-label small">Borrar</label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody id="empty-form-template" class="d-none">
                        <tr>
                            <td>{{ formset.empty_form.codigo }} {{ formset.empty_form.id }}</td>
                            <td>{{ formset.empty_form.descripcion }}</td>
                            <td>{{ formset.empty_form.bodega }}</td>
                            <td>{{ formset.empty_form.cantidad }}</td>
                            <td class="text-center">
                                {% if formset.empty_form.DELETE %}
                                    <div class="form-check">
                                        {{ formset.empty_form.DELETE }}
                                        <label class="form-check-label small">Borrar</label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAgregarLinea">
                    <i class="bi bi-plus-circle me-1"></i>Agregar l√≠nea
                </button>
                <small class="text-muted ms-2">Agrega l√≠neas seg√∫n necesites (m√°ximo 45).</small>
            </div>
            {% endif %}

            {% if es_edicion_avanzada %}
            <!-- Secci√≥n de Edici√≥n de Fechas de Preparaci√≥n (Admin) -->
            <div class="mt-5 border-top pt-4">
                <h5 class="mb-3">
                    <i class="bi bi-clock-history me-2"></i>
                    Edici√≥n de Productos y Fechas de Preparaci√≥n
                    <span class="badge bg-warning text-dark">Control Completo</span>
                </h5>
                <p class="text-muted small">
                    Edita c√≥digos, cantidades, bodegas y ajusta las fechas/horas de preparaci√≥n si hubo errores. 
                    Tambi√©n puedes agregar o eliminar productos. Esto afecta directamente los KPIs.
                </p>
                
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 150px;">C√≥digo</th>
                                <th>Descripci√≥n</th>
                                <th style="width: 100px;">Cantidad</th>
                                <th style="width: 200px;">Bodega</th>
                                <th style="width: 120px;">Estado</th>
                                <th style="min-width: 200px;">Fecha/Hora Preparaci√≥n</th>
                                <th style="width: 80px;">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="detalle-rows-edicion">
                            {% for form in formset %}
                            <tr>
                                <td>
                                    {{ form.id }}
                                    {{ form.codigo }}
                                    {% if form.codigo.errors %}
                                        <div class="text-danger small">{{ form.codigo.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.descripcion }}
                                    {% if form.descripcion.errors %}
                                        <div class="text-danger small">{{ form.descripcion.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.cantidad }}
                                    {% if form.cantidad.errors %}
                                        <div class="text-danger small">{{ form.cantidad.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.bodega }}
                                    {% if form.bodega.errors %}
                                        <div class="text-danger small">{{ form.bodega.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.estado_bodega }}
                                    {% if form.estado_bodega.errors %}
                                        <div class="text-danger small">{{ form.estado_bodega.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.fecha_preparacion }}
                                    {% if form.fecha_preparacion.errors %}
                                    <div class="text-danger small">{{ form.fecha_preparacion.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if form.DELETE %}
                                        <div class="form-check">
                                            {{ form.DELETE }}
                                            <label class="form-check-label small">Borrar</label>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tbody id="empty-form-template-edicion" class="d-none">
                            <tr>
                                <td>{{ formset.empty_form.codigo }} {{ formset.empty_form.id }}</td>
                                <td>{{ formset.empty_form.descripcion }}</td>
                                <td>{{ formset.empty_form.cantidad }}</td>
                                <td>{{ formset.empty_form.bodega }}</td>
                                <td>{{ formset.empty_form.estado_bodega }}</td>
                                <td>{{ formset.empty_form.fecha_preparacion }}</td>
                                <td class="text-center">
                                    {% if formset.empty_form.DELETE %}
                                        <div class="form-check">
                                            {{ formset.empty_form.DELETE }}
                                            <label class="form-check-label small">Borrar</label>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btnAgregarLineaEdicion">
                        <i class="bi bi-plus-circle me-1"></i>Agregar l√≠nea
                    </button>
                    <small class="text-muted ms-2">Agrega nuevos productos seg√∫n necesites (m√°ximo 45).</small>
                </div>
            </div>

            <!-- Secci√≥n de Edici√≥n de Fechas de Bultos (Admin) -->
            {% if formset_bultos %}
            <div class="mt-5 border-top pt-4">
                <h5 class="mb-3">
                    <i class="bi bi-box-seam me-2"></i>
                    Fechas de Embalaje y Despacho de Bultos
                    <span class="badge bg-warning text-dark">Control de KPIs</span>
                </h5>
                <p class="text-muted small">
                    Ajusta las fechas y horas de embalaje, env√≠o y entrega si hubo errores en el registro. 
                    Esto afecta directamente los KPIs de tiempo de despacho.
                </p>
                
                {{ formset_bultos.management_form }}
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>C√≥digo Bulto</th>
                                <th>Estado</th>
                                <th style="min-width: 200px;">Fecha/Hora Embalaje</th>
                                <th style="min-width: 200px;">Fecha/Hora Env√≠o</th>
                                <th style="min-width: 200px;">Fecha/Hora Entrega</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset_bultos %}
                            <tr>
                                <td>
                                    {{ form.id }}
                                    <strong>{{ form.instance.codigo }}</strong>
                                </td>
                                <td>{{ form.estado }}</td>
                                <td>
                                    {{ form.fecha_embalaje }}
                                    {% if form.fecha_embalaje.errors %}
                                    <div class="text-danger small">{{ form.fecha_embalaje.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.fecha_envio }}
                                    {% if form.fecha_envio.errors %}
                                    <div class="text-danger small">{{ form.fecha_envio.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.fecha_entrega }}
                                    {% if form.fecha_entrega.errors %}
                                    <div class="text-danger small">{{ form.fecha_entrega.errors|striptags }}</div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Alerta de validaci√≥n -->
                <div class="alert alert-info mt-3" id="alertValidacion" style="display: none;">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Validaci√≥n de fechas:</strong>
                    <ul id="listaValidaciones" class="mb-0 mt-2"></ul>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <div class="mt-4 d-flex justify-content-end">
                <a href="{% url 'solicitudes:lista' %}" class="btn btn-light me-2">Cancelar</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>Guardar Solicitud
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnAgregar = document.getElementById('btnAgregarLinea');
    const tbody = document.getElementById('detalle-rows');
    const template = document.querySelector('#empty-form-template tr');
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
    const maxForms = 45;
    const csrfToken = '{{ csrf_token }}';

    if (!btnAgregar || !tbody || !template || !totalFormsInput) return;

    // Funci√≥n para buscar c√≥digo en stock
    function buscarCodigoEnStock(codigoInput) {
        const codigo = codigoInput.value.trim().toUpperCase();
        if (!codigo || codigo.length < 3) return;

        const row = codigoInput.closest('tr');
        const descripcionInput = row.querySelector('[name*="descripcion"]');
        const bodegaSelect = row.querySelector('[name*="bodega"]');
        
        console.log('üîç Buscando c√≥digo:', codigo);

        fetch('/solicitudes/api/buscar-codigo/?codigo=' + encodeURIComponent(codigo))
            .then(response => response.json())
            .then(data => {
                console.log('üì¶ Respuesta:', data);
                
                if (data.success) {
                    // Autocompletar descripci√≥n
                    if (descripcionInput) {
                        descripcionInput.value = data.descripcion || '';
                        descripcionInput.readOnly = true;
                        descripcionInput.style.backgroundColor = '#e9ecef';
                    }
                    
                    // Mostrar informaci√≥n de stock
                    let stockInfo = '';
                    if (data.bodegas && data.bodegas.length > 0) {
                        stockInfo = '<div class="alert alert-success alert-sm mt-1 mb-0 py-1 px-2 small">';
                        stockInfo += '<strong>Stock disponible:</strong><br>';
                        data.bodegas.forEach(b => {
                            stockInfo += `üì¶ <strong>${b.codigo_bodega}</strong> (${b.nombre_bodega}): ${b.stock_disponible} unidades<br>`;
                        });
                        stockInfo += '</div>';
                        
                        // Actualizar opciones de bodega
                        if (bodegaSelect) {
                            // Guardar la opci√≥n vac√≠a si existe
                            const emptyOption = bodegaSelect.querySelector('option[value=""]');
                            
                            // Limpiar opciones actuales excepto la vac√≠a
                            bodegaSelect.innerHTML = '';
                            if (emptyOption) {
                                bodegaSelect.appendChild(emptyOption.cloneNode(true));
                            }
                            
                            // Agregar solo las bodegas que tienen stock de este c√≥digo
                            data.bodegas.forEach(b => {
                                const option = new Option(
                                    `${b.codigo_bodega} ¬∑ ${b.nombre_bodega} (Stock: ${b.stock_disponible})`, 
                                    b.codigo_bodega
                                );
                                bodegaSelect.add(option);
                            });
                            
                            // Seleccionar autom√°ticamente la primera bodega con stock
                            if (data.bodegas.length === 1) {
                                bodegaSelect.value = data.bodegas[0].codigo_bodega;
                            } else if (data.bodegas.length > 1) {
                                // Resaltar el select para que el usuario elija
                                bodegaSelect.style.borderColor = '#0d6efd';
                                bodegaSelect.style.borderWidth = '2px';
                            }
                        }
                    } else {
                        stockInfo = '<div class="alert alert-warning alert-sm mt-1 mb-0 py-1 px-2 small">';
                        stockInfo += '‚ö†Ô∏è <strong>Sin stock disponible</strong> en ninguna bodega. Puedes seleccionar una bodega manualmente si deseas continuar.';
                        stockInfo += '</div>';
                    }
                    
                    // Insertar informaci√≥n despu√©s de la fila
                    let infoRow = row.nextElementSibling;
                    if (infoRow && infoRow.classList.contains('stock-info-row')) {
                        infoRow.remove();
                    }
                    
                    const newInfoRow = document.createElement('tr');
                    newInfoRow.classList.add('stock-info-row');
                    newInfoRow.innerHTML = `<td colspan="4">${stockInfo}</td>`;
                    row.after(newInfoRow);
                    
                } else {
                    // C√≥digo no encontrado
                    if (descripcionInput) {
                        descripcionInput.value = '';
                        descripcionInput.readOnly = false;
                        descripcionInput.style.backgroundColor = '';
                    }
                    
                    let infoRow = row.nextElementSibling;
                    if (infoRow && infoRow.classList.contains('stock-info-row')) {
                        infoRow.remove();
                    }
                    
                    const newInfoRow = document.createElement('tr');
                    newInfoRow.classList.add('stock-info-row');
                    newInfoRow.innerHTML = `<td colspan="4"><div class="alert alert-danger alert-sm mt-1 mb-0 py-1 px-2 small">‚ùå ${data.message}</div></td>`;
                    row.after(newInfoRow);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Agregar evento a los inputs de c√≥digo existentes
    tbody.querySelectorAll('[name*="codigo"]').forEach(input => {
        input.addEventListener('blur', function() {
            buscarCodigoEnStock(this);
        });
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
    
    // Agregar evento a los selects de bodega existentes
    tbody.querySelectorAll('[name*="bodega"]').forEach(select => {
        select.addEventListener('change', function() {
            this.style.borderColor = '';
            this.style.borderWidth = '';
        });
    });

    // Agregar nueva l√≠nea
    btnAgregar.addEventListener('click', function() {
        let total = parseInt(totalFormsInput.value || '0', 10);
        if (total >= maxForms) {
            alert('Ya alcanzaste el m√°ximo de 45 l√≠neas de productos.');
            return;
        }

        const newRow = template.cloneNode(true);
        let html = newRow.innerHTML.replace(/__prefix__/g, total);
        newRow.innerHTML = html;
        
        // Agregar eventos a los nuevos inputs
        const codigoInput = newRow.querySelector('[name*="codigo"]');
        const bodegaSelect = newRow.querySelector('[name*="bodega"]');
        
        if (codigoInput) {
            codigoInput.addEventListener('blur', function() {
                buscarCodigoEnStock(this);
            });
            codigoInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }
        
        // Resetear estilo del select de bodega al cambiar
        if (bodegaSelect) {
            bodegaSelect.addEventListener('change', function() {
                this.style.borderColor = '';
                this.style.borderWidth = '';
            });
        }
        
        tbody.appendChild(newRow);
        totalFormsInput.value = total + 1;
        
        // Enfocar el nuevo input de c√≥digo
        if (codigoInput) {
            codigoInput.focus();
        }
    });
});
</script>

{% if es_edicion_avanzada %}
<script>
// ============================================================
// VALIDACI√ìN DE FECHAS PARA CONTROL DE KPIs
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    const alertValidacion = document.getElementById('alertValidacion');
    const listaValidaciones = document.getElementById('listaValidaciones');
    
    if (!alertValidacion || !listaValidaciones) return;
    
    // Funci√≥n para validar consistencia de fechas
    function validarFechas() {
        const validaciones = [];
        
        // Obtener todas las fechas de preparaci√≥n
        const fechasPreparacion = [];
        document.querySelectorAll('[name*="detalles-"][name*="-fecha_preparacion"]').forEach(input => {
            if (input.value) {
                fechasPreparacion.push({
                    elemento: input,
                    fecha: new Date(input.value),
                    nombre: 'Preparaci√≥n'
                });
            }
        });
        
        // Obtener todas las fechas de bultos
        const fechasEmbalaje = [];
        const fechasEnvio = [];
        const fechasEntrega = [];
        
        document.querySelectorAll('[name*="bultos-"][name*="-fecha_embalaje"]').forEach(input => {
            if (input.value) {
                fechasEmbalaje.push({
                    elemento: input,
                    fecha: new Date(input.value),
                    nombre: 'Embalaje',
                    row: input.closest('tr')
                });
            }
        });
        
        document.querySelectorAll('[name*="bultos-"][name*="-fecha_envio"]').forEach(input => {
            if (input.value) {
                fechasEnvio.push({
                    elemento: input,
                    fecha: new Date(input.value),
                    nombre: 'Env√≠o',
                    row: input.closest('tr')
                });
            }
        });
        
        document.querySelectorAll('[name*="bultos-"][name*="-fecha_entrega"]').forEach(input => {
            if (input.value) {
                fechasEntrega.push({
                    elemento: input,
                    fecha: new Date(input.value),
                    nombre: 'Entrega',
                    row: input.closest('tr')
                });
            }
        });
        
        // Validaci√≥n 1: Embalaje debe ser despu√©s de preparaci√≥n
        if (fechasPreparacion.length > 0 && fechasEmbalaje.length > 0) {
            const maxPreparacion = Math.max(...fechasPreparacion.map(f => f.fecha.getTime()));
            fechasEmbalaje.forEach(emb => {
                if (emb.fecha.getTime() < maxPreparacion) {
                    validaciones.push({
                        tipo: 'warning',
                        mensaje: `‚ö†Ô∏è Fecha de embalaje (${emb.fecha.toLocaleString('es-CL')}) es anterior a la √∫ltima preparaci√≥n. Esto generar√° KPI negativo.`,
                        elemento: emb.elemento
                    });
                }
            });
        }
        
        // Validaci√≥n 2: Env√≠o debe ser despu√©s de embalaje (mismo bulto)
        fechasEmbalaje.forEach((emb, index) => {
            const envioMismoBulto = fechasEnvio[index];
            if (envioMismoBulto && envioMismoBulto.fecha.getTime() < emb.fecha.getTime()) {
                validaciones.push({
                    tipo: 'error',
                    mensaje: `‚ùå Fecha de env√≠o (${envioMismoBulto.fecha.toLocaleString('es-CL')}) es anterior al embalaje del mismo bulto. Esto es inconsistente.`,
                    elemento: envioMismoBulto.elemento
                });
            }
        });
        
        // Validaci√≥n 3: Entrega debe ser despu√©s de env√≠o (mismo bulto)
        fechasEnvio.forEach((env, index) => {
            const entregaMismoBulto = fechasEntrega[index];
            if (entregaMismoBulto && entregaMismoBulto.fecha.getTime() < env.fecha.getTime()) {
                validaciones.push({
                    tipo: 'error',
                    mensaje: `‚ùå Fecha de entrega (${entregaMismoBulto.fecha.toLocaleString('es-CL')}) es anterior al env√≠o del mismo bulto. Esto es inconsistente.`,
                    elemento: entregaMismoBulto.elemento
                });
            }
        });
        
        // Mostrar validaciones
        if (validaciones.length > 0) {
            listaValidaciones.innerHTML = '';
            validaciones.forEach(v => {
                const li = document.createElement('li');
                li.textContent = v.mensaje;
                li.className = v.tipo === 'error' ? 'text-danger' : 'text-warning';
                listaValidaciones.appendChild(li);
                
                // Resaltar campo con problema
                if (v.elemento) {
                    v.elemento.style.borderColor = v.tipo === 'error' ? '#dc3545' : '#ffc107';
                    v.elemento.style.borderWidth = '2px';
                }
            });
            alertValidacion.style.display = 'block';
            alertValidacion.className = validaciones.some(v => v.tipo === 'error') ? 
                'alert alert-danger mt-3' : 'alert alert-warning mt-3';
        } else {
            alertValidacion.style.display = 'none';
            // Limpiar estilos de campos
            document.querySelectorAll('[name*="-fecha_"]').forEach(input => {
                input.style.borderColor = '';
                input.style.borderWidth = '';
            });
        }
    }
    
    // Ejecutar validaci√≥n al cambiar cualquier fecha
    document.querySelectorAll('[name*="-fecha_"]').forEach(input => {
        input.addEventListener('change', validarFechas);
        input.addEventListener('blur', validarFechas);
    });
    
    // Validar al cargar la p√°gina
    validarFechas();
    
    // Advertencia al enviar formulario si hay errores
    document.getElementById('formSolicitud').addEventListener('submit', function(e) {
        const tieneErrores = alertValidacion.style.display !== 'none' && 
                            alertValidacion.classList.contains('alert-danger');
        
        if (tieneErrores) {
            if (!confirm('‚ö†Ô∏è Hay inconsistencias en las fechas que pueden afectar los KPIs.\n\n¬øDeseas guardar de todas formas?')) {
                e.preventDefault();
            }
        }
    });
});

// ============================================================
// AGREGAR/ELIMINAR L√çNEAS DE PRODUCTOS EN EDICI√ìN AVANZADA
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    const btnAgregarEdicion = document.getElementById('btnAgregarLineaEdicion');
    const tbodyEdicion = document.getElementById('detalle-rows-edicion');
    const templateEdicion = document.querySelector('#empty-form-template-edicion tr');
    const totalFormsInputEdicion = document.getElementById('id_detalles-TOTAL_FORMS');
    const maxForms = 45;

    if (!btnAgregarEdicion || !tbodyEdicion || !templateEdicion || !totalFormsInputEdicion) return;

    console.log('üîß Sistema de edici√≥n avanzada de productos inicializado');

    // Funci√≥n para buscar c√≥digo en stock (versi√≥n simplificada para edici√≥n)
    function buscarCodigoEnStockEdicion(codigoInput) {
        const codigo = codigoInput.value.trim().toUpperCase();
        if (!codigo || codigo.length < 3) return;

        const row = codigoInput.closest('tr');
        const descripcionInput = row.querySelector('[name*="descripcion"]');
        const bodegaSelect = row.querySelector('[name*="bodega"]');
        
        console.log('üîç Buscando c√≥digo en edici√≥n:', codigo);

        fetch('/solicitudes/api/buscar-codigo/?codigo=' + encodeURIComponent(codigo))
            .then(response => response.json())
            .then(data => {
                console.log('üì¶ Respuesta:', data);
                
                if (data.success) {
                    // Autocompletar descripci√≥n
                    if (descripcionInput && !descripcionInput.value) {
                        descripcionInput.value = data.descripcion || '';
                    }
                    
                    // Actualizar opciones de bodega si hay stock
                    if (data.bodegas && data.bodegas.length > 0 && bodegaSelect) {
                        const emptyOption = bodegaSelect.querySelector('option[value=""]');
                        const currentValue = bodegaSelect.value;
                        
                        // Limpiar y reconstruir opciones
                        bodegaSelect.innerHTML = '';
                        if (emptyOption) {
                            bodegaSelect.appendChild(emptyOption.cloneNode(true));
                        }
                        
                        data.bodegas.forEach(b => {
                            const option = new Option(
                                `${b.codigo_bodega} ¬∑ ${b.nombre_bodega} (Stock: ${b.stock_disponible})`, 
                                b.codigo_bodega
                            );
                            bodegaSelect.add(option);
                        });
                        
                        // Mantener selecci√≥n previa si es v√°lida, sino seleccionar primera con stock
                        if (currentValue && data.bodegas.some(b => b.codigo_bodega === currentValue)) {
                            bodegaSelect.value = currentValue;
                        } else if (data.bodegas.length === 1) {
                            bodegaSelect.value = data.bodegas[0].codigo_bodega;
                        }
                    }
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Agregar eventos a inputs existentes
    tbodyEdicion.querySelectorAll('[name*="codigo"]').forEach(input => {
        input.addEventListener('blur', function() {
            buscarCodigoEnStockEdicion(this);
        });
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });

    // Agregar nueva l√≠nea
    btnAgregarEdicion.addEventListener('click', function() {
        let total = parseInt(totalFormsInputEdicion.value || '0', 10);
        if (total >= maxForms) {
            alert('Ya alcanzaste el m√°ximo de 45 l√≠neas de productos.');
            return;
        }

        const newRow = templateEdicion.cloneNode(true);
        let html = newRow.innerHTML.replace(/__prefix__/g, total);
        newRow.innerHTML = html;
        
        // Agregar eventos a los nuevos inputs
        const codigoInput = newRow.querySelector('[name*="codigo"]');
        const bodegaSelect = newRow.querySelector('[name*="bodega"]');
        
        if (codigoInput) {
            codigoInput.addEventListener('blur', function() {
                buscarCodigoEnStockEdicion(this);
            });
            codigoInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }
        
        if (bodegaSelect) {
            bodegaSelect.addEventListener('change', function() {
                this.style.borderColor = '';
                this.style.borderWidth = '';
            });
        }
        
        tbodyEdicion.appendChild(newRow);
        totalFormsInputEdicion.value = total + 1;
        
        console.log('‚ûï Nueva l√≠nea agregada. Total:', total + 1);
        
        // Enfocar el nuevo input de c√≥digo
        if (codigoInput) {
            codigoInput.focus();
        }
    });
});
</script>
{% endif %}

{% endblock %}
