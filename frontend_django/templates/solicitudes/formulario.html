{% extends 'base.html' %}

{% block title %}{% if es_edicion %}Editar{% else %}Nueva{% endif %} Solicitud - Sistema PESCO{% endblock %}

{% block extra_css %}
<style>
.stock-info-row {
    background-color: #f8f9fa;
}
.stock-info-row td {
    padding: 0.25rem 0.5rem !important;
}
.alert-sm {
    font-size: 0.875rem;
    line-height: 1.4;
}
input[readonly] {
    background-color: #e9ecef !important;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="bi bi-{% if es_edicion %}pencil{% else %}file-earmark-plus{% endif %} me-2"></i>
            {% if es_edicion %}Editar Solicitud #{{ solicitud.id }}{% else %}Nueva Solicitud{% endif %}
        </h1>
        <p class="text-muted mb-0">Formulario de ingreso manual para el equipo administrativo.</p>
    </div>
    <a href="{% url 'solicitudes:lista' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Volver al listado
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" novalidate id="formSolicitud">
            {% csrf_token %}

            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">{{ form.tipo.label }}</label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                        <div class="text-danger small mt-1">{{ form.tipo.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_pedido.label }}</label>
                    {{ form.numero_pedido }}
                    <small class="text-muted">OF o n√∫mero manual</small>
                    {% if form.numero_pedido.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_pedido.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_ot.label }}</label>
                    {{ form.numero_ot }}
                    <small class="text-muted">Orden de transporte (OT) si aplica.</small>
                    {% if form.numero_ot.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_ot.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% if es_edicion %}
                <div class="col-md-3">
                    <label class="form-label">{{ form.numero_guia_despacho.label }}</label>
                    {{ form.numero_guia_despacho }}
                    <small class="text-muted">Gu√≠a o factura del despacho.</small>
                    {% if form.numero_guia_despacho.errors %}
                        <div class="text-danger small mt-1">{{ form.numero_guia_despacho.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="col-md-12">
                    <label class="form-label">{{ form.cliente.label }}</label>
                    {{ form.cliente }}
                    {% if form.cliente.errors %}
                        <div class="text-danger small mt-1">{{ form.cliente.errors|striptags }}</div>
                    {% endif %}
                </div>

                <div class="{% if es_edicion %}col-md-6{% else %}col-md-12{% endif %}">
                    <label class="form-label">Transporte</label>
                    <select name="{{ form.transporte.name }}" class="form-select" id="id_{{ form.transporte.name }}">
                        {% for value, label in form.transporte.field.choices %}
                        <option value="{{ value }}" {% if form.transporte.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.transporte.errors %}
                        <div class="text-danger small mt-1">{{ form.transporte.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% if es_edicion %}
                <div class="col-md-6">
                    <label class="form-label">Estado</label>
                    <select name="{{ form.estado.name }}" class="form-select" id="id_{{ form.estado.name }}">
                        {% for value, label in form.estado.field.choices %}
                        <option value="{{ value }}" {% if form.estado.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.estado.errors %}
                        <div class="text-danger small mt-1">{{ form.estado.errors|striptags }}</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="col-md-6">
                <div class="col-md-3 d-flex align-items-center mt-4">
                    <div class="form-check form-switch">
                        {{ form.urgente }}
                        <label class="form-check-label ms-2">{{ form.urgente.label }}</label>
                    </div>
                    {% if form.urgente.errors %}
                        <div class="text-danger small ms-3">{{ form.urgente.errors|striptags }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-3 d-flex align-items-center mt-4">
                    <div class="form-check form-switch">
                        {{ form.afecta_stock }}
                        <label class="form-check-label ms-2">{{ form.afecta_stock.label }}</label>
                    </div>
                    <small class="text-muted d-block ms-3">Desmarcar para √≥rdenes especiales</small>
                    {% if form.afecta_stock.errors %}
                        <div class="text-danger small ms-3">{{ form.afecta_stock.errors|striptags }}</div>
                    {% endif %}
                </div>

                <div class="col-md-12">
                    <label class="form-label">{{ form.observacion.label }}</label>
                    {{ form.observacion }}
                    {% if form.observacion.errors %}
                        <div class="text-danger small mt-1">{{ form.observacion.errors|striptags }}</div>
                    {% endif %}
                </div>

            </div>

            <!-- Detalles adicionales -->
            <hr class="my-4">
            <h5>Productos adicionales</h5>
            <p class="text-muted">
                <i class="bi bi-info-circle me-1"></i> 
                Ingresa cada c√≥digo y selecciona de qu√© <strong>bodega</strong> se preparar√°. 
                M√∫ltiples usuarios de bodega ver√°n esta solicitud y entregar√°n los materiales desde su bodega asignada.
            </p>

            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th style="width: 150px;">C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th style="width: 200px;">Bodega</th>
                            <th style="width: 100px;">Cantidad</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="detalle-rows">
                        {{ formset.management_form }}
                        {% for f in formset %}
                        <tr>
                            <td>
                                {{ f.codigo }}
                                {{ f.id }}
                                {% if f.codigo.errors %}
                                    <div class="text-danger small">{{ f.codigo.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.descripcion }}
                                {% if f.descripcion.errors %}
                                    <div class="text-danger small">{{ f.descripcion.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.bodega }}
                                {% if f.bodega.errors %}
                                    <div class="text-danger small">{{ f.bodega.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ f.cantidad }}
                                {% if f.cantidad.errors %}
                                    <div class="text-danger small">{{ f.cantidad.errors|striptags }}</div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if f.DELETE %}
                                    <div class="form-check">
                                        {{ f.DELETE }}
                                        <label class="form-check-label small">Borrar</label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody id="empty-form-template" class="d-none">
                        <tr>
                            <td>{{ formset.empty_form.codigo }} {{ formset.empty_form.id }}</td>
                            <td>{{ formset.empty_form.descripcion }}</td>
                            <td>{{ formset.empty_form.bodega }}</td>
                            <td>{{ formset.empty_form.cantidad }}</td>
                            <td class="text-center">
                                {% if formset.empty_form.DELETE %}
                                    <div class="form-check">
                                        {{ formset.empty_form.DELETE }}
                                        <label class="form-check-label small">Borrar</label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAgregarLinea">
                    <i class="bi bi-plus-circle me-1"></i>Agregar l√≠nea
                </button>
                <small class="text-muted ms-2">Agrega l√≠neas seg√∫n necesites (m√°ximo 45).</small>
            </div>

            <div class="mt-4 d-flex justify-content-end">
                <a href="{% url 'solicitudes:lista' %}" class="btn btn-light me-2">Cancelar</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>Guardar Solicitud
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnAgregar = document.getElementById('btnAgregarLinea');
    const tbody = document.getElementById('detalle-rows');
    const template = document.querySelector('#empty-form-template tr');
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
    const maxForms = 45;
    const csrfToken = '{{ csrf_token }}';

    if (!btnAgregar || !tbody || !template || !totalFormsInput) return;

    // Funci√≥n para buscar c√≥digo en stock
    function buscarCodigoEnStock(codigoInput) {
        const codigo = codigoInput.value.trim().toUpperCase();
        if (!codigo || codigo.length < 3) return;

        const row = codigoInput.closest('tr');
        const descripcionInput = row.querySelector('[name*="descripcion"]');
        const bodegaSelect = row.querySelector('[name*="bodega"]');
        
        console.log('üîç Buscando c√≥digo:', codigo);

        fetch('/solicitudes/api/buscar-codigo/?codigo=' + encodeURIComponent(codigo))
            .then(response => response.json())
            .then(data => {
                console.log('üì¶ Respuesta:', data);
                
                if (data.success) {
                    // Autocompletar descripci√≥n
                    if (descripcionInput) {
                        descripcionInput.value = data.descripcion || '';
                        descripcionInput.readOnly = true;
                        descripcionInput.style.backgroundColor = '#e9ecef';
                    }
                    
                    // Mostrar informaci√≥n de stock
                    let stockInfo = '';
                    if (data.bodegas && data.bodegas.length > 0) {
                        stockInfo = '<div class="alert alert-success alert-sm mt-1 mb-0 py-1 px-2 small">';
                        stockInfo += '<strong>Stock disponible:</strong><br>';
                        data.bodegas.forEach(b => {
                            stockInfo += `üì¶ <strong>${b.codigo_bodega}</strong> (${b.nombre_bodega}): ${b.stock_disponible} unidades<br>`;
                        });
                        stockInfo += '</div>';
                        
                        // Actualizar opciones de bodega
                        if (bodegaSelect) {
                            // Guardar la opci√≥n vac√≠a si existe
                            const emptyOption = bodegaSelect.querySelector('option[value=""]');
                            
                            // Limpiar opciones actuales excepto la vac√≠a
                            bodegaSelect.innerHTML = '';
                            if (emptyOption) {
                                bodegaSelect.appendChild(emptyOption.cloneNode(true));
                            }
                            
                            // Agregar solo las bodegas que tienen stock de este c√≥digo
                            data.bodegas.forEach(b => {
                                const option = new Option(
                                    `${b.codigo_bodega} ¬∑ ${b.nombre_bodega} (Stock: ${b.stock_disponible})`, 
                                    b.codigo_bodega
                                );
                                bodegaSelect.add(option);
                            });
                            
                            // Seleccionar autom√°ticamente la primera bodega con stock
                            if (data.bodegas.length === 1) {
                                bodegaSelect.value = data.bodegas[0].codigo_bodega;
                            } else if (data.bodegas.length > 1) {
                                // Resaltar el select para que el usuario elija
                                bodegaSelect.style.borderColor = '#0d6efd';
                                bodegaSelect.style.borderWidth = '2px';
                            }
                        }
                    } else {
                        stockInfo = '<div class="alert alert-warning alert-sm mt-1 mb-0 py-1 px-2 small">';
                        stockInfo += '‚ö†Ô∏è <strong>Sin stock disponible</strong> en ninguna bodega. Puedes seleccionar una bodega manualmente si deseas continuar.';
                        stockInfo += '</div>';
                    }
                    
                    // Insertar informaci√≥n despu√©s de la fila
                    let infoRow = row.nextElementSibling;
                    if (infoRow && infoRow.classList.contains('stock-info-row')) {
                        infoRow.remove();
                    }
                    
                    const newInfoRow = document.createElement('tr');
                    newInfoRow.classList.add('stock-info-row');
                    newInfoRow.innerHTML = `<td colspan="4">${stockInfo}</td>`;
                    row.after(newInfoRow);
                    
                } else {
                    // C√≥digo no encontrado
                    if (descripcionInput) {
                        descripcionInput.value = '';
                        descripcionInput.readOnly = false;
                        descripcionInput.style.backgroundColor = '';
                    }
                    
                    let infoRow = row.nextElementSibling;
                    if (infoRow && infoRow.classList.contains('stock-info-row')) {
                        infoRow.remove();
                    }
                    
                    const newInfoRow = document.createElement('tr');
                    newInfoRow.classList.add('stock-info-row');
                    newInfoRow.innerHTML = `<td colspan="4"><div class="alert alert-danger alert-sm mt-1 mb-0 py-1 px-2 small">‚ùå ${data.message}</div></td>`;
                    row.after(newInfoRow);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Agregar evento a los inputs de c√≥digo existentes
    tbody.querySelectorAll('[name*="codigo"]').forEach(input => {
        input.addEventListener('blur', function() {
            buscarCodigoEnStock(this);
        });
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
    
    // Agregar evento a los selects de bodega existentes
    tbody.querySelectorAll('[name*="bodega"]').forEach(select => {
        select.addEventListener('change', function() {
            this.style.borderColor = '';
            this.style.borderWidth = '';
        });
    });

    // Agregar nueva l√≠nea
    btnAgregar.addEventListener('click', function() {
        let total = parseInt(totalFormsInput.value || '0', 10);
        if (total >= maxForms) {
            alert('Ya alcanzaste el m√°ximo de 45 l√≠neas de productos.');
            return;
        }

        const newRow = template.cloneNode(true);
        let html = newRow.innerHTML.replace(/__prefix__/g, total);
        newRow.innerHTML = html;
        
        // Agregar eventos a los nuevos inputs
        const codigoInput = newRow.querySelector('[name*="codigo"]');
        const bodegaSelect = newRow.querySelector('[name*="bodega"]');
        
        if (codigoInput) {
            codigoInput.addEventListener('blur', function() {
                buscarCodigoEnStock(this);
            });
            codigoInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }
        
        // Resetear estilo del select de bodega al cambiar
        if (bodegaSelect) {
            bodegaSelect.addEventListener('change', function() {
                this.style.borderColor = '';
                this.style.borderWidth = '';
            });
        }
        
        tbody.appendChild(newRow);
        totalFormsInput.value = total + 1;
        
        // Enfocar el nuevo input de c√≥digo
        if (codigoInput) {
            codigoInput.focus();
        }
    });
});
</script>
{% endblock %}
