<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Modal - Diagn√≥stico</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico del Modal - Sistema PESCO</h1>
    
    <div class="test-section">
        <h2>Test 1: Verificar Configuraci√≥n</h2>
        <button onclick="testConfig()">Ejecutar Test</button>
        <div id="result1" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Cambiar Afecta Stock (Solicitud #9)</h2>
        <button onclick="testAfectaStock()">Cambiar a NO afecta stock</button>
        <div id="result2" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Cambiar Estado a Despachado (Solicitud #9)</h2>
        <button onclick="testCambiarEstado()">Marcar como Despachado</button>
        <div id="result3" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Proceso Completo (Solicitud seleccionable)</h2>
        <input type="number" id="solicitudId" placeholder="ID de solicitud" value="9">
        <button onclick="testProcesoCompleto()">Ejecutar Proceso Completo</button>
        <div id="result4" class="result"></div>
    </div>

    <script>
        // Obtener CSRF token de las cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        function testConfig() {
            const result = document.getElementById('result1');
            result.className = 'result';
            result.textContent = 'Verificando configuraci√≥n...\n\n';
            
            result.textContent += `CSRF Token: ${csrftoken ? '‚úì Encontrado' : '‚úó NO encontrado'}\n`;
            result.textContent += `Token: ${csrftoken}\n\n`;
            
            result.textContent += `Base URL: ${window.location.origin}\n`;
            result.textContent += `Current Path: ${window.location.pathname}\n\n`;
            
            result.textContent += `URLs de prueba:\n`;
            result.textContent += `  - Afecta Stock: /solicitudes/9/afecta-stock/\n`;
            result.textContent += `  - Cambiar Estado: /solicitudes/9/cambiar-estado/\n`;
            
            result.className = 'result success';
        }
        
        function testAfectaStock() {
            const result = document.getElementById('result2');
            result.className = 'result';
            result.textContent = 'Enviando petici√≥n...\n';
            
            fetch('/solicitudes/9/afecta-stock/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'afecta_stock=false'
            })
            .then(response => {
                result.textContent += `Status: ${response.status}\n`;
                return response.json();
            })
            .then(data => {
                result.textContent += `Response:\n${JSON.stringify(data, null, 2)}\n`;
                result.className = data.success ? 'result success' : 'result error';
                
                if (data.success) {
                    Swal.fire('¬°√âxito!', data.message, 'success');
                }
            })
            .catch(error => {
                result.textContent += `\nERROR: ${error}\n`;
                result.className = 'result error';
                Swal.fire('Error', error.toString(), 'error');
            });
        }
        
        function testCambiarEstado() {
            const result = document.getElementById('result3');
            result.className = 'result';
            result.textContent = 'Enviando petici√≥n...\n';
            
            fetch('/solicitudes/9/cambiar-estado/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'estado=despachado&numero_guia_despacho=TEST-DIAGNOSTICO-001'
            })
            .then(response => {
                result.textContent += `Status: ${response.status}\n`;
                return response.json();
            })
            .then(data => {
                result.textContent += `Response:\n${JSON.stringify(data, null, 2)}\n`;
                result.className = data.success ? 'result success' : 'result error';
                
                if (data.success) {
                    Swal.fire({
                        title: '¬°√âxito!',
                        html: data.message + '<br><br>Recarga la p√°gina de solicitudes para ver los cambios.',
                        icon: 'success'
                    });
                }
            })
            .catch(error => {
                result.textContent += `\nERROR: ${error}\n`;
                result.className = 'result error';
                Swal.fire('Error', error.toString(), 'error');
            });
        }
        
        async function testProcesoCompleto() {
            const result = document.getElementById('result4');
            const solicitudId = document.getElementById('solicitudId').value;
            
            result.className = 'result';
            result.textContent = `Iniciando proceso completo para solicitud #${solicitudId}...\n\n`;
            
            try {
                // Paso 1: Cambiar afecta_stock
                result.textContent += '1Ô∏è‚É£ Cambiando afecta_stock a FALSE...\n';
                const resp1 = await fetch(`/solicitudes/${solicitudId}/afecta-stock/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'afecta_stock=false'
                });
                const data1 = await resp1.json();
                result.textContent += `   ${data1.success ? '‚úì' : '‚úó'} ${data1.message}\n\n`;
                
                // Esperar 500ms
                await new Promise(r => setTimeout(r, 500));
                
                // Paso 2: Cambiar estado
                result.textContent += '2Ô∏è‚É£ Cambiando estado a DESPACHADO...\n';
                const resp2 = await fetch(`/solicitudes/${solicitudId}/cambiar-estado/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'estado=despachado&numero_guia_despacho=PROCESO-COMPLETO-' + Date.now()
                });
                const data2 = await resp2.json();
                result.textContent += `   ${data2.success ? '‚úì' : '‚úó'} ${data2.message}\n\n`;
                
                if (data1.success && data2.success) {
                    result.textContent += '‚úÖ PROCESO COMPLETADO EXITOSAMENTE\n';
                    result.className = 'result success';
                    
                    Swal.fire({
                        title: '¬°Proceso Completado!',
                        html: `Solicitud #${solicitudId} actualizada correctamente.<br><br>` +
                              `<strong>Cambios aplicados:</strong><br>` +
                              `‚Ä¢ Afecta Stock: NO<br>` +
                              `‚Ä¢ Estado: Despachado<br>` +
                              `‚Ä¢ N¬∞ Gu√≠a: PROCESO-COMPLETO-${Date.now()}<br><br>` +
                              `Recarga la p√°gina de solicitudes para ver los cambios.`,
                        icon: 'success',
                        confirmButtonText: 'Entendido'
                    });
                } else {
                    result.textContent += '‚ùå HUBO ERRORES EN EL PROCESO\n';
                    result.className = 'result error';
                }
                
            } catch (error) {
                result.textContent += `\n‚ùå ERROR: ${error}\n`;
                result.className = 'result error';
                Swal.fire('Error', error.toString(), 'error');
            }
        }
    </script>
</body>
</html>

