# Solicitud de Desarrollo MVP â€“ Sistema LogÃ­stico PESCO

## ğŸ“Œ Contexto
La empresa **PESCO** utiliza actualmente **SAP en modo web** para la gestiÃ³n de stock y reporterÃ­a.  
Debido a la dificultad de acceder a queries rÃ¡pidas, la operaciÃ³n logÃ­stica se apoya en un **Excel compartido en SharePoint**, donde se registran solicitudes y movimientos diarios.

El flujo operativo se centra en tres Ã¡reas principales:
- **Bodega** (Entrega de mercaderÃ­a a despacho)
- **Despacho** (Embalaje, pesaje y etiquetado)
- **AdministraciÃ³n** (EmisiÃ³n de guÃ­as SAP y registro final)

Actualmente, el registro manual en Excel genera problemas de eficiencia, duplicidad y errores humanos.

---

## ğŸ¯ Objetivo del MVP
Construir un sistema web simple en **Python/Django**, con base de datos en **Supabase**, que permita:
1. **Registrar solicitudes** de manera ordenada y trazable.
2. **Manejar stock** mediante cargas temporales desde Excel (descargado de SAP).
3. **Evitar duplicidad de solicitudes** validando contra stock y pedidos pendientes.
4. **Generar informes exportables a Excel** para mantener compatibilidad con la operaciÃ³n actual.
5. **Proveer KPIs** (dÃ­as en despacho, lead time) para anÃ¡lisis logÃ­stico.

---

## ğŸ› ï¸ Requerimientos Funcionales

### ğŸ”„ Flujo de Trabajo Completo

```
1. SOLICITUD INICIAL (Admin/Ventas)
        â†“
2. BODEGA â†’ Entrega a Despacho
        â†“
3. DESPACHO â†’ Embala, Pesa, Mide
        â†“
4. ADMIN â†’ Emite GuÃ­a SAP + Registra OT
        â†“
5. DESPACHADO
```

---

### 1. Registro de Solicitudes (Admin)
**Usuario**: Admin (puede hacerlo tambiÃ©n ventas/RRHH si se habilitan)

- âœ… **IMPLEMENTADO**: Ingreso manual de solicitudes: ventas, RRHH, EPP, emergencias, ambulancia, retiros de camiÃ³n y **retiros urgentes de clientes**.
- **Campos principales**:
  - Fecha (recepciÃ³n) - automÃ¡tica
  - Hora (registro) - automÃ¡tica
  - Tipo (PC, OC, EM, ST, OF, **RM**) - âœ… Implementado con todos los tipos
  - **NÃºmero de pedido** (PC/OF/EM/RM) - opcional, manual
  - **NÃºmero ST** (ST) - âœ… **Auto-generado** con formato `ST-AAAA-###`, reinicia cada aÃ±o
  - Cliente
  - **MÃºltiples productos** - âœ… Implementado con `SolicitudDetalle` (hasta 45 lÃ­neas)
  - CÃ³digo producto (puede ser "SC" para sin cÃ³digo)
  - DescripciÃ³n
  - Cantidad solicitada
  - Bodega origen - âœ… **Opcional** (admin o IA la asignarÃ¡ despuÃ©s)
  - **Transporte** - âœ… Dropdown: CamiÃ³n PESCO, Varmontt, Starken, Kaizen, Retira cliente, Otro
  - ObservaciÃ³n
  - Urgente (checkbox)
- **Estado inicial**: `pendiente`
- âœ… **Formulario dinÃ¡mico**: Inicia con 5 lÃ­neas de producto, botÃ³n "Agregar lÃ­nea" para hasta 45 productos

---

### 2. MÃ³dulo de Bodega (Usuario Bodega)
**Usuario**: Bodega (acceso limitado)

**FunciÃ³n**: Registrar entrega de mercaderÃ­a a Despacho

- **Campos a registrar**:
  - NÃºmero de transferencia (Ãºnico)
  - Fecha de entrega
  - Hora de entrega
  - Productos entregados (lista con cantidades)
  - Observaciones (opcional)

- **Acciones**:
  - Ver solicitudes pendientes
  - Seleccionar solicitud(es) a procesar
  - Registrar nÃºmero de transferencia
  - Confirmar entrega a despacho

- **Estado cambia a**: `en_despacho`

**Restricciones**: 
- âŒ No puede ver mÃ³dulo de despacho
- âŒ No puede emitir guÃ­as
- âœ… Solo puede registrar transferencias

---

### 3. MÃ³dulo de Despacho (Usuario Despacho)
**Usuario**: Despacho (acceso limitado)

**FunciÃ³n**: Recibir mercaderÃ­a, embalar, pesar, medir y etiquetar

- **Campos a registrar**:
  - Fecha/hora de embalado
  - Peso (kg)
  - Medidas (largo x ancho x alto en cm)
  - NÃºmero de bultos
  - Transporte (PESCO / EXTERNO)
  - Transportista (si es externo: Starken, Varmontt, etc.)
  - Observaciones

- **Acciones**:
  - Ver solicitudes "en_despacho"
  - Registrar datos de embalaje
  - Pesar productos
  - Medir bultos
  - **Generar e imprimir etiquetas de bultos** 
    - ğŸ“Œ **Modelo de etiqueta pendiente** (serÃ¡ proporcionado por el usuario)
    - Sistema generarÃ¡ PDF para impresiÃ³n
    - IncluirÃ¡: cÃ³digo producto, cliente, bulto X de Y, peso, medidas

- **Estado cambia a**: `embalado`

**Restricciones**:
- âŒ No puede ver mÃ³dulo de bodega
- âŒ No puede emitir guÃ­as SAP
- âœ… Solo puede embalar y etiquetar

---

### 4. MÃ³dulo de EmisiÃ³n de GuÃ­as (Solo Admin)
**Usuario**: **Solo Admin**

**FunciÃ³n**: Emitir guÃ­a en SAP y registrar nÃºmeros oficiales

- **Campos a registrar**:
  - NÃºmero de GuÃ­a de Despacho (de SAP)
  - NÃºmero(s) de OT (orden de trabajo/traslado)
  - Fecha/hora de emisiÃ³n
  - Observaciones finales

- **Acciones**:
  - Ver solicitudes "embaladas"
  - Emitir guÃ­a en SAP (fuera del sistema)
  - Registrar nÃºmero de guÃ­a en el sistema
  - Registrar nÃºmero(s) de OT
  - Confirmar despacho final

- **Estado cambia a**: `despachado`

**Nota importante**: El admin emite la guÃ­a directamente en **SAP** (sistema externo) y solo **registra el nÃºmero** en este sistema para trazabilidad.

---

### 5. Rol de Administrador (Acceso Total)
**Usuario**: Admin (tÃº)

**Privilegios especiales**:
- âœ… **Acceso a todos los mÃ³dulos** (Bodega, Despacho, GuÃ­as)
- âœ… Puede completar cualquier paso del proceso
- âœ… Puede reemplazar a cualquier usuario si falta personal
- âœ… Puede hacer todo el flujo completo solo
- âœ… Acceso a reportes y KPIs
- âœ… GestiÃ³n de usuarios
- âœ… ConfiguraciÃ³n del sistema

**Casos de uso**:
- Si falta personal de bodega â†’ Admin puede registrar transferencias
- Si falta personal de despacho â†’ Admin puede embalar y etiquetar
- Admin siempre emite las guÃ­as SAP

---

### 6. KPIs AutomÃ¡ticos
- **DÃ­as en despacho**: Desde que bodega entrega hasta que admin emite guÃ­a
- **Lead time total**: Desde solicitud inicial hasta despacho final
- **Solicitudes urgentes**: Contador y tiempo promedio de respuesta
- **Eficiencia por Ã¡rea**: Tiempo promedio en bodega vs despacho

---

## ğŸ“Š Flujo de Estados del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CICLO DE VIDA DE SOLICITUD                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PENDIENTE  â”‚  â† Estado inicial (Admin crea solicitud)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ğŸ“¦ Usuario BODEGA registra:
       â”‚    - NÃºmero transferencia
       â”‚    - Fecha/hora entrega
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚EN_DESPACHO  â”‚  â† Esperando que Despacho procese
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ğŸšš Usuario DESPACHO registra:
       â”‚    - Peso, medidas
       â”‚    - NÃºmero de bultos
       â”‚    - Genera etiquetas
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EMBALADO   â”‚  â† Esperando que Admin emita guÃ­a
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ğŸ‘¤ Usuario ADMIN registra:
       â”‚    - GuÃ­a SAP (emitida en SAP)
       â”‚    - NÃºmero(s) OT
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DESPACHADO  â”‚  â† Estado final âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       âŒ CANCELADO â† Puede cancelarse en cualquier momento (solo Admin)
```

### Estados Detallados

| Estado | Color | DescripciÃ³n | QuiÃ©n puede cambiar |
|--------|-------|-------------|---------------------|
| `pendiente` | ğŸŸ¡ Amarillo | Solicitud creada, esperando bodega | â†’ Bodega |
| `en_despacho` | ğŸ”µ Azul | MercaderÃ­a entregada a despacho | â†’ Despacho |
| `embalado` | ğŸŸ¢ Verde claro | Embalado y listo, falta guÃ­a | â†’ Admin |
| `despachado` | ğŸŸ¢ Verde | Completado con guÃ­a SAP | Estado final |
| `cancelado` | ğŸ”´ Rojo | Solicitud cancelada | Solo Admin |

---

## ğŸ—„ï¸ Manejo de Base de Datos

### Supabase
- Usado para **registro de solicitudes y KPIs**.
- Ventajas:
  - Plan gratuito suficiente para ~20 solicitudes diarias (â‰ˆ4,400 mensuales).
  - Escalable en caso de crecimiento.
- ContendrÃ¡ tablas:
  - `solicitudes`
  - `bodega_transferencias`
  - `despachos`
  - `kpis`

### Excel (base temporal externa)
- Usado para **cargas masivas de stock y pedidos pendientes** desde SAP.
- Flujo:
  1. Cada maÃ±ana se descarga stock desde SAP.
  2. Se sube al sistema como archivo Excel/CSV.
  3. El sistema valida solicitudes contra stock/pedidos pendientes.
- No se almacena en Supabase para evitar costos elevados.

---

## ğŸ“Š Informes
- El sistema debe exportar reportes en **Excel** para:
  - Encargados de bodega
  - Despacho
  - AdministraciÃ³n
- Reportes incluyen:
  - Solicitudes pendientes
  - Transferencias realizadas
  - Despachos emitidos
  - KPIs de tiempos

---

## ğŸ” Roles y Permisos

### Roles del Sistema

1. **ğŸ‘¤ Admin (TÃº)** â†’ Acceso total, puede hacer TODO:
   - Crear solicitudes
   - Registrar transferencias de bodega
   - Embalar y etiquetar en despacho
   - **Emitir guÃ­as SAP y registrar OT**
   - Ver reportes y KPIs
   - Gestionar usuarios

2. **ğŸ“¦ Bodega** â†’ Acceso limitado:
   - Ver solicitudes pendientes
   - Registrar transferencias a despacho
   - Ver historial de sus transferencias

3. **ğŸšš Despacho** â†’ Acceso limitado:
   - Ver solicitudes en despacho
   - Registrar embalaje, peso, medidas
   - Generar e imprimir etiquetas de bultos
   - Ver historial de sus despachos

---

## ğŸš€ Alcance del MVP
1. **Ingreso de solicitudes manuales** con validaciÃ³n contra stock cargado desde Excel.  
2. **Dashboard en tabla simple** mostrando estados (pendiente, listo, embalado, despachado, urgente).  
3. **Carga de stock/pedidos pendientes vÃ­a Excel/CSV**.  
4. **ExportaciÃ³n de reportes a Excel**.  
5. **KPIs bÃ¡sicos**: dÃ­as en despacho y lead time.  

---

## ğŸ› ï¸ Stack TecnolÃ³gico

### Backend
- **Python 3.11+**
- **Django 5.0+** (Framework principal)
- **Supabase** (Base de datos PostgreSQL)
  - Ãndices optimizados para consultas rÃ¡pidas
  - Plan gratuito: 500MB storage, 50K usuarios activos
- **Django REST Framework** (APIs)
- **MCP Server** (Model Context Protocol para integraciÃ³n con IA)
  - Biblioteca: `mcp-django`
  - Permite interacciÃ³n con asistentes de IA

### Frontend
- **Bootstrap 5** (Framework CSS responsivo)
- **JavaScript (ES6+)** (Interactividad)
- **Django Templates** (Renderizado del lado del servidor)
- **Componentes modulares reutilizables** (evitar cÃ³digo repetitivo)

### GestiÃ³n de Datos
- **Pandas** (Procesamiento de archivos Excel/CSV)
- **openpyxl** (Lectura y escritura de Excel)
- **Cookies** (CachÃ© de consultas frecuentes para reducir carga en DB)

### Deployment
- **Render** (Hosting web gratuito/pago)
- **Gunicorn** (Servidor WSGI)
- **WhiteNoise** (Archivos estÃ¡ticos)

---

## ğŸ¨ DiseÃ±o UI/UX

### Paleta de Colores
Basada en dashboard corporativo profesional:
- **Azul Principal**: `#00B4D8` (turquesa/celeste) - Elementos principales, navbar
- **Verde**: `#4CAF50` - Estados completados, alertas positivas
- **Amarillo**: `#FFC107` - Estados pendientes, advertencias
- **Rojo**: `#F44336` - Estados cancelados, alertas crÃ­ticas
- **Gris**: `#6C757D` - Texto secundario
- **Blanco**: `#FFFFFF` - Fondos de tarjetas

### Componentes UI
- **Dashboard con KPIs** (tarjetas mÃ©tricas con iconos)
- **Tablas responsivas** con paginaciÃ³n
- **Formularios validados** con feedback visual
- **Filtros dinÃ¡micos** sin recargar pÃ¡gina
- **Notificaciones toast** para acciones del usuario
- **ExportaciÃ³n a Excel** con un clic

---

## ğŸ—ï¸ Arquitectura del Sistema

### âœ… Estructura del Proyecto Implementada

```
sistemaPesco/
â”œâ”€â”€ backend/                  # ConfiguraciÃ³n Django
â”‚   â”œâ”€â”€ settings.py          # Settings con Supabase, Gemini, etc.
â”‚   â”œâ”€â”€ urls.py              # URLs principales
â”‚   â””â”€â”€ wsgi.py
â”‚
â”œâ”€â”€ core/                    # App central âœ… IMPLEMENTADO
â”‚   â”œâ”€â”€ models.py           # Usuario (rol: admin/bodega/despacho)
â”‚   â”œâ”€â”€ views.py            # Dashboard, login, logout, perfil
â”‚   â”œâ”€â”€ decorators.py       # @role_required
â”‚   â”œâ”€â”€ admin.py            # Admin personalizado
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ dashboard.html
â”‚       â”œâ”€â”€ login.html
â”‚       â””â”€â”€ perfil.html
â”‚
â”œâ”€â”€ solicitudes/            # MÃ³dulo de solicitudes âœ… IMPLEMENTADO
â”‚   â”œâ”€â”€ models.py          # Solicitud + SolicitudDetalle
â”‚   â”œâ”€â”€ views.py           # CRUD + API IA
â”‚   â”œâ”€â”€ forms.py           # SolicitudForm + SolicitudDetalleFormSet
â”‚   â”œâ”€â”€ services.py        # crear_solicitud_desde_payload()
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ lista.html
â”‚       â”œâ”€â”€ formulario.html
â”‚       â””â”€â”€ detalle.html
â”‚
â”œâ”€â”€ ia/                     # MÃ³dulo de IA âœ… IMPLEMENTADO
â”‚   â”œâ”€â”€ gemini_client.py   # call_gemini_for_solicitud()
â”‚   â”œâ”€â”€ views.py          # ia_chat (vista web)
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ chat.html
â”‚
â”œâ”€â”€ frontend_django/        # Templates globales âœ… IMPLEMENTADO
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ base.html
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ navbar.html
â”‚           â””â”€â”€ sidebar.html
â”‚
â”œâ”€â”€ mcp_server.py          # Servidor MCP âœ… IMPLEMENTADO
â”œâ”€â”€ test/                  # Tests
â”‚   â””â”€â”€ test_gemini.py
â”œâ”€â”€ manage.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

### Arquitectura Modular (Inspirada en sistemaGDV)

```
sistemaPesco/
â”œâ”€â”€ config/                  # ConfiguraciÃ³n Django
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ base.py         # Settings comunes
â”‚   â”‚   â”œâ”€â”€ development.py  # Settings desarrollo
â”‚   â”‚   â””â”€â”€ production.py   # Settings producciÃ³n
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ wsgi.py
â”‚
â”œâ”€â”€ apps/                    # Aplicaciones modulares
â”‚   â”œâ”€â”€ core/               # Funcionalidades centrales
â”‚   â”‚   â”œâ”€â”€ models.py      # Usuario, etc.
â”‚   â”‚   â”œâ”€â”€ views.py       # Dashboard, login
â”‚   â”‚   â”œâ”€â”€ decorators.py  # @role_required
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ dashboard.html
â”‚   â”‚
â”‚   â”œâ”€â”€ solicitudes/        # MÃ³dulo de solicitudes (Admin)
â”‚   â”‚   â”œâ”€â”€ models.py      # Modelo Solicitud
â”‚   â”‚   â”œâ”€â”€ views.py       # CRUD solicitudes
â”‚   â”‚   â”œâ”€â”€ forms.py       # Formularios
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â”œâ”€â”€ solicitud_lista.html
â”‚   â”‚       â””â”€â”€ solicitud_form.html
â”‚   â”‚
â”‚   â”œâ”€â”€ bodega/             # MÃ³dulo de bodega
â”‚   â”‚   â”œâ”€â”€ models.py      # Modelo Transferencia
â”‚   â”‚   â”œâ”€â”€ views.py       # Vista solo para bodega
â”‚   â”‚   â”œâ”€â”€ forms.py       # Form transferencia
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ bodega_panel.html
â”‚   â”‚
â”‚   â”œâ”€â”€ despacho/           # MÃ³dulo de despacho
â”‚   â”‚   â”œâ”€â”€ models.py      # Modelo Embalaje
â”‚   â”‚   â”œâ”€â”€ views.py       # Vista solo para despacho
â”‚   â”‚   â”œâ”€â”€ forms.py       # Form embalaje
â”‚   â”‚   â”œâ”€â”€ etiquetas.py   # GeneraciÃ³n de etiquetas PDF
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â”œâ”€â”€ despacho_panel.html
â”‚   â”‚       â””â”€â”€ etiqueta_bulto.html
â”‚   â”‚
â”‚   â”œâ”€â”€ guias/              # MÃ³dulo de guÃ­as SAP (Solo Admin)
â”‚   â”‚   â”œâ”€â”€ views.py       # Registro de guÃ­as
â”‚   â”‚   â”œâ”€â”€ forms.py       # Form guÃ­a + OT
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ guias_panel.html
â”‚   â”‚
â”‚   â”œâ”€â”€ reportes/           # MÃ³dulo de reportes y KPIs
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ exporters.py   # LÃ³gica de exportaciÃ³n Excel
â”‚   â”‚   â”œâ”€â”€ kpis.py        # CÃ¡lculo de KPIs
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ reportes.html
â”‚   â”‚
â”‚   â””â”€â”€ stock/              # MÃ³dulo de gestiÃ³n de stock (opcional)
â”‚       â”œâ”€â”€ models.py      # CachÃ© de stock
â”‚       â”œâ”€â”€ importers.py   # Carga desde Excel
â”‚       â””â”€â”€ validators.py  # ValidaciÃ³n contra SAP
â”‚
â”œâ”€â”€ static/                  # Archivos estÃ¡ticos
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ bootstrap.min.css
â”‚   â”‚   â””â”€â”€ custom.css     # Estilos personalizados
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ bootstrap.bundle.min.js
â”‚   â”‚   â””â”€â”€ app.js         # JavaScript global
â”‚   â””â”€â”€ img/
â”‚
â”œâ”€â”€ templates/              # Templates globales
â”‚   â”œâ”€â”€ base.html          # Template base (navbar, footer)
â”‚   â”œâ”€â”€ dashboard.html     # Dashboard principal
â”‚   â””â”€â”€ components/        # Componentes reutilizables
â”‚       â”œâ”€â”€ card_kpi.html
â”‚       â”œâ”€â”€ table.html
â”‚       â””â”€â”€ form_modal.html
â”‚
â”œâ”€â”€ utils/                  # Utilidades compartidas
â”‚   â”œâ”€â”€ decorators.py
â”‚   â”œâ”€â”€ helpers.py
â”‚   â””â”€â”€ validators.py
â”‚
â”œâ”€â”€ mcp/                    # Servidor MCP para IA
â”‚   â”œâ”€â”€ server.py
â”‚   â””â”€â”€ tools.py
â”‚
â”œâ”€â”€ requirements/
â”‚   â”œâ”€â”€ base.txt
â”‚   â”œâ”€â”€ development.txt
â”‚   â””â”€â”€ production.txt
â”‚
â”œâ”€â”€ .env.example
â”œâ”€â”€ manage.py
â””â”€â”€ README.md
```

### Principios de Arquitectura
1. **SeparaciÃ³n de responsabilidades** (SoC)
2. **DRY (Don't Repeat Yourself)** - Componentes reutilizables
3. **Modularidad** - Cada app Django es independiente
4. **Escalabilidad** - FÃ¡cil agregar nuevos mÃ³dulos
5. **Mantenibilidad** - CÃ³digo limpio y documentado

---

## ğŸ—„ï¸ Estructura de Base de Datos (Supabase)

### Tablas Principales

#### `solicitudes`
```sql
CREATE TABLE solicitudes (
    id SERIAL PRIMARY KEY,
    fecha_solicitud DATE NOT NULL,
    hora_solicitud TIME NOT NULL,
    tipo VARCHAR(2) CHECK (tipo IN ('PC', 'OC', 'EM', 'ST', 'OF', 'RM')),
    numero_pedido VARCHAR(50), -- Opcional para PC/OF/EM/RM
    numero_st VARCHAR(20), -- Auto-generado para ST (formato: ST-AAAA-###)
    cliente VARCHAR(200),
    codigo VARCHAR(50), -- CÃ³digo del primer producto (legacy)
    descripcion TEXT, -- DescripciÃ³n del primer producto (legacy)
    cantidad_solicitada INTEGER, -- Cantidad del primer producto (legacy)
    bodega VARCHAR(50), -- Opcional (puede quedar vacÃ­o)
    transporte VARCHAR(20) DEFAULT 'PESCO' CHECK (transporte IN ('PESCO', 'VARMONTT', 'STARKEN', 'KAIZEN', 'RETIRA_CLIENTE', 'OTRO')),
    observacion TEXT,
    estado VARCHAR(20) DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'en_despacho', 'embalado', 'despachado', 'cancelado')),
    urgente BOOLEAN DEFAULT FALSE,
    solicitante_id INTEGER REFERENCES usuarios(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices para optimizaciÃ³n
CREATE INDEX idx_solicitudes_fecha ON solicitudes(fecha_solicitud DESC);
CREATE INDEX idx_solicitudes_estado ON solicitudes(estado);
CREATE INDEX idx_solicitudes_codigo ON solicitudes(codigo);
CREATE INDEX idx_solicitudes_urgente ON solicitudes(urgente);
CREATE INDEX idx_solicitudes_cliente ON solicitudes(cliente);
CREATE INDEX idx_solicitudes_tipo_created ON solicitudes(tipo, created_at);

-- Comentarios sobre estados:
-- pendiente: Solicitud creada, esperando bodega
-- en_despacho: Bodega entregÃ³ a despacho
-- embalado: Despacho terminÃ³ de embalar
-- despachado: Admin emitiÃ³ guÃ­a SAP
-- cancelado: Solicitud cancelada
```

#### `solicitudes_detalle`
```sql
CREATE TABLE solicitudes_detalle (
    id SERIAL PRIMARY KEY,
    solicitud_id INTEGER REFERENCES solicitudes(id) ON DELETE CASCADE,
    codigo VARCHAR(50) NOT NULL,
    descripcion TEXT,
    cantidad INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_solicitudes_detalle_solicitud ON solicitudes_detalle(solicitud_id, codigo);
```

**Nota**: Las solicitudes pueden tener mÃºltiples productos (hasta 45 lÃ­neas). Los campos `codigo`, `descripcion`, `cantidad_solicitada` en la tabla `solicitudes` se mantienen por compatibilidad con solicitudes antiguas que no usan `solicitudes_detalle`.

#### `bodega_transferencias`
```sql
CREATE TABLE bodega_transferencias (
    id SERIAL PRIMARY KEY,
    solicitud_id INTEGER REFERENCES solicitudes(id) ON DELETE CASCADE,
    numero_transferencia VARCHAR(50) UNIQUE NOT NULL,
    fecha_transferencia DATE NOT NULL,
    hora_transferencia TIME NOT NULL,
    encargado_id INTEGER REFERENCES usuarios(id),
    observaciones TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_transferencias_solicitud ON bodega_transferencias(solicitud_id);
CREATE INDEX idx_transferencias_fecha ON bodega_transferencias(fecha_transferencia DESC);
```

#### `despachos`
```sql
CREATE TABLE despachos (
    id SERIAL PRIMARY KEY,
    solicitud_id INTEGER REFERENCES solicitudes(id) ON DELETE CASCADE,
    
    -- Datos de embalaje (registrados por Despacho)
    fecha_embalado DATE NOT NULL,
    hora_embalado TIME NOT NULL,
    peso DECIMAL(10,2), -- kg
    medidas VARCHAR(50), -- formato: "largo x ancho x alto cm"
    numero_bultos INTEGER DEFAULT 1,
    transporte VARCHAR(20) CHECK (transporte IN ('PESCO', 'EXTERNO')),
    transportista VARCHAR(100), -- Si es externo: Starken, Varmontt, etc.
    encargado_embalaje_id INTEGER REFERENCES usuarios(id),
    observaciones_embalaje TEXT,
    
    -- Datos de guÃ­a SAP (registrados por Admin)
    guia_despacho VARCHAR(50) UNIQUE, -- NÃºmero de guÃ­a SAP (nullable hasta que admin la emite)
    numero_ot VARCHAR(200), -- Puede ser mÃºltiples OTs separados por comas
    fecha_guia DATE,
    hora_guia TIME,
    admin_emisor_id INTEGER REFERENCES usuarios(id),
    observaciones_guia TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_despachos_solicitud ON despachos(solicitud_id);
CREATE INDEX idx_despachos_fecha_embalado ON despachos(fecha_embalado DESC);
CREATE INDEX idx_despachos_fecha_guia ON despachos(fecha_guia DESC);
CREATE INDEX idx_despachos_guia ON despachos(guia_despacho);
CREATE INDEX idx_despachos_transporte ON despachos(transporte);
```

#### `kpis`
```sql
CREATE TABLE kpis (
    id SERIAL PRIMARY KEY,
    solicitud_id INTEGER REFERENCES solicitudes(id) ON DELETE CASCADE,
    dias_en_despacho INTEGER,
    lead_time_horas DECIMAL(10,2),
    calculado_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_kpis_solicitud ON kpis(solicitud_id);
```

#### `usuarios`
```sql
CREATE TABLE usuarios (
    id SERIAL PRIMARY KEY,
    username VARCHAR(150) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL, -- Hash de contraseÃ±a
    email VARCHAR(254) UNIQUE NOT NULL,
    nombre_completo VARCHAR(200),
    rol VARCHAR(20) CHECK (rol IN ('admin', 'bodega', 'despacho')),
    is_active BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_usuarios_rol ON usuarios(rol);
CREATE INDEX idx_usuarios_username ON usuarios(username);

-- Usuario admin por defecto (password debe ser hasheado)
INSERT INTO usuarios (username, email, nombre_completo, rol, is_active) 
VALUES ('admin', 'admin@pesco.cl', 'Administrador Principal', 'admin', TRUE);
```

---

## ğŸ” Sistema de AutenticaciÃ³n y Permisos

### Roles y Accesos Detallados
| Rol | Crear Solicitud | Registrar Transferencia | Embalar/Pesar/Medir | Emitir GuÃ­a SAP | Reportes | KPIs | GestiÃ³n Usuarios |
|-----|----------------|------------------------|---------------------|-----------------|----------|------|------------------|
| **ğŸ‘¤ Admin** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **ğŸ“¦ Bodega** | âŒ | âœ… | âŒ | âŒ | âš ï¸ Solo sus transferencias | âŒ | âŒ |
| **ğŸšš Despacho** | âŒ | âŒ | âœ… | âŒ | âš ï¸ Solo sus despachos | âŒ | âŒ |

**Nota importante**: Solo el **Admin** puede emitir guÃ­as SAP y tener acceso completo a todos los mÃ³dulos.

### ImplementaciÃ³n
```python
# utils/decorators.py
from functools import wraps
from django.contrib.auth.decorators import login_required
from django.http import HttpResponseForbidden

def role_required(allowed_roles):
    def decorator(view_func):
        @wraps(view_func)
        @login_required
        def wrapper(request, *args, **kwargs):
            if request.user.rol in allowed_roles:
                return view_func(request, *args, **kwargs)
            return HttpResponseForbidden("No tienes permisos para acceder")
        return wrapper
    return decorator
```

---

## ğŸ¤– IntegraciÃ³n con Inteligencia Artificial

### âœ… Asistente IA Integrado en la Web

El sistema incluye un **Asistente IA** integrado directamente en la aplicaciÃ³n web, accesible desde el menÃº lateral para usuarios Admin.

**Funcionalidades**:
- âœ… **Procesamiento de texto**: Pega el contenido de un correo electrÃ³nico y la IA extrae automÃ¡ticamente:
  - Tipo de solicitud (PC, OF, EM, RM, ST)
  - NÃºmero de pedido (si aplica)
  - Cliente
  - CÃ³digos de productos y cantidades
  - Observaciones adicionales (direcciones de entrega, instrucciones de facturaciÃ³n, etc.)
- âœ… **Procesamiento de imÃ¡genes**: Sube capturas de pantalla de SAP y la IA:
  - Identifica nÃºmeros de pedido
  - Extrae cÃ³digos de productos y cantidades
  - Genera automÃ¡ticamente la solicitud completa

**TecnologÃ­a**: 
- **Gemini 2.5 Flash** (`google-generativeai`)
- Modelo configurado con prompt especializado para extracciÃ³n de datos logÃ­sticos
- IntegraciÃ³n directa con el sistema de creaciÃ³n de solicitudes

**UbicaciÃ³n**: `/ia/chat/` (requiere autenticaciÃ³n y rol Admin)

### âœ… API Endpoint para Agentes IA Externos

**Endpoint**: `POST /solicitudes/api/ia/crear/`

**AutenticaciÃ³n**: Token API (`X-API-TOKEN` o `Authorization: Bearer`)

**Payload JSON**:
```json
{
  "tipo": "PC",
  "numero_pedido": "25111045",
  "cliente": "SUC LOS ANGELES",
  "bodega": "013-01",
  "transporte": "CamiÃ³n PESCO",
  "estado": "pendiente",
  "urgente": false,
  "observacion": "Entregar en direcciÃ³n...",
  "productos": [
    {"codigo": "3502040", "descripcion": "CILINDRO", "cantidad": 5},
    {"codigo": "3502021", "descripcion": "VALVULA", "cantidad": 2}
  ]
}
```

**Respuesta**:
```json
{
  "ok": true,
  "id": 123,
  "tipo": "PC",
  "numero_pedido": "25111045",
  "cliente": "SUC LOS ANGELES",
  "estado": "pendiente"
}
```

### âœ… MCP Server (Model Context Protocol)

**Archivo**: `mcp_server.py` (raÃ­z del proyecto)

**Herramientas expuestas**:
- `ping()`: VerificaciÃ³n de conectividad
- `crear_solicitud(payload_json)`: Crear solicitud desde JSON

**ConfiguraciÃ³n**:
```bash
pip install mcp django
```

**EjecuciÃ³n**:
```bash
python mcp_server.py
```

**Uso con IA Externa**:
Permite que asistentes de IA (Claude Desktop, ChatGPT con plugins MCP, etc.) interactÃºen directamente con el sistema para:
- âœ… Crear solicitudes automÃ¡ticamente desde correos o imÃ¡genes
- Consultar solicitudes pendientes (pendiente)
- Generar reportes automÃ¡ticos (pendiente)
- AnÃ¡lisis predictivo de stock (pendiente)

### ConfiguraciÃ³n de Variables de Entorno

**`.env`**:
```bash
GEMINI_API_KEY=tu_api_key_de_google_ai_studio
GEMINI_MODEL=gemini-2.5-flash
IA_API_TOKEN=tu_token_secreto_para_api
```

**âš ï¸ IMPORTANTE**: 
- La API key de Gemini debe obtenerse desde **Google AI Studio** (https://aistudio.google.com)
- No usar API keys genÃ©ricas de Google Cloud (no son compatibles)

---

## âš¡ Optimizaciones de Rendimiento

### 1. Ãndices en Supabase
- Ya definidos en estructura de tablas
- Mejoran velocidad de consultas en 70-90%

### 2. Cookies para CachÃ©
```python
# utils/cache.py
from django.core.cache import cache

def get_stock_cache(bodega):
    cache_key = f'stock_{bodega}'
    stock = cache.get(cache_key)
    if not stock:
        stock = cargar_stock_desde_excel(bodega)
        cache.set(cache_key, stock, timeout=3600)  # 1 hora
    return stock
```

### 3. Queries Optimizadas
```python
# Usar select_related y prefetch_related
solicitudes = Solicitud.objects.select_related(
    'solicitante', 'bodega_transferencia', 'despacho'
).prefetch_related('kpis')
```

### 4. PaginaciÃ³n
```python
# views.py
from django.core.paginator import Paginator

def lista_solicitudes(request):
    solicitudes = Solicitud.objects.all().order_by('-fecha_solicitud')
    paginator = Paginator(solicitudes, 25)  # 25 por pÃ¡gina
    page = paginator.get_page(request.GET.get('page'))
    return render(request, 'solicitudes/lista.html', {'page': page})
```

---

## ğŸ“Š Dashboard y VisualizaciÃ³n

### KPIs Principales (Tarjetas)
1. **Niveles de Inventario** ğŸ“¦
   - Total items en stock
   - VariaciÃ³n respecto al mes pasado

2. **Ã“rdenes Pendientes** ğŸ“‹
   - NÃºmero de Ã³rdenes sin procesar
   - Ã“rdenes urgentes destacadas

3. **EnvÃ­os Hoy** ğŸšš
   - Preparados para despacho
   - En trÃ¡nsito

4. **Alertas CrÃ­ticas** âš ï¸
   - Stock bajo lÃ­mite
   - Retrasos en despacho

### Tabla de Actividad Reciente
- Estados con colores (completado=verde, pendiente=amarillo, cancelado=rojo)
- Filtros por cliente, estado, fecha
- ExportaciÃ³n directa a Excel

---

## ğŸ·ï¸ Sistema de Etiquetas de Bultos

### Funcionalidad
El mÃ³dulo de Despacho debe poder generar e imprimir etiquetas para cada bulto embalado.

### Datos en la Etiqueta (Pendiente definir formato exacto)
- **NÃºmero de bulto**: "Bulto 1 de 3"
- **CÃ³digo de producto**: SKU o cÃ³digo interno
- **Cliente**: Nombre o razÃ³n social
- **Peso**: En kilogramos
- **Medidas**: Largo x Ancho x Alto (cm)
- **Fecha de embalaje**
- **CÃ³digo de barras o QR** (opcional): Para tracking

### ImplementaciÃ³n TÃ©cnica
```python
# apps/despacho/etiquetas.py
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

def generar_etiqueta_bulto(solicitud, numero_bulto, total_bultos, peso, medidas):
    """
    Genera un PDF con la etiqueta del bulto
    """
    filename = f'etiqueta_{solicitud.id}_bulto_{numero_bulto}.pdf'
    c = canvas.Canvas(filename, pagesize=A4)
    
    # DiseÃ±o de la etiqueta (pendiente modelo del usuario)
    c.drawString(100, 750, f"PESCO - Sistema LogÃ­stico")
    c.drawString(100, 700, f"Cliente: {solicitud.cliente}")
    c.drawString(100, 650, f"Producto: {solicitud.codigo} - {solicitud.descripcion}")
    c.drawString(100, 600, f"Bulto: {numero_bulto} de {total_bultos}")
    c.drawString(100, 550, f"Peso: {peso} kg")
    c.drawString(100, 500, f"Medidas: {medidas}")
    
    # CÃ³digo de barras (opcional)
    # Implementar con librerÃ­a python-barcode
    
    c.save()
    return filename
```

### Biblioteca Requerida
```bash
pip install reportlab python-barcode
```

### Flujo de Uso
1. Usuario Despacho ingresa datos de embalaje
2. Sistema pregunta: "Â¿CuÃ¡ntos bultos?"
3. Sistema genera un PDF con todas las etiquetas
4. Usuario descarga e imprime las etiquetas
5. Etiquetas se adhieren fÃ­sicamente a los bultos

**ğŸ“Œ Nota**: El formato final de la etiqueta serÃ¡ proporcionado por el usuario.

---

## ğŸ“¦ Requirements

### base.txt
```
Django>=5.0
psycopg2-binary>=2.9
supabase>=2.0
python-dotenv>=1.0
pandas>=2.0
openpyxl>=3.1
xlsxwriter>=3.1
reportlab>=4.0
python-barcode>=0.15
djangorestframework>=3.14
django-cors-headers>=4.3
gunicorn>=21.0
whitenoise>=6.6
mcp>=0.1.0
google-generativeai>=0.3.0
Pillow>=10.0
```

### development.txt
```
-r base.txt
django-debug-toolbar>=4.2
black>=23.0
flake8>=6.0
```

---

## ğŸš€ InstalaciÃ³n y ConfiguraciÃ³n

### 1. Clonar repositorio
```bash
git clone https://github.com/tuusuario/sistemaPesco.git
cd sistemaPesco
```

### 2. Crear entorno virtual
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
```

### 3. Instalar dependencias
```bash
pip install -r requirements/development.txt
```

### 4. Configurar variables de entorno
```bash
cp .env.example .env
# Editar .env con:
# - SECRET_KEY (generar uno nuevo para producciÃ³n)
# - DEBUG=True (desarrollo)
# - GEMINI_API_KEY (obtener de https://aistudio.google.com)
# - GEMINI_MODEL=gemini-2.5-flash
# - IA_API_TOKEN (token secreto para API de IA)
# - Credenciales de Supabase (cuando se configure)
```

### 5. Ejecutar migraciones
```bash
python manage.py makemigrations
python manage.py migrate
```

### 6. Crear superusuario
```bash
python manage.py createsuperuser
```

### 7. Ejecutar servidor
```bash
python manage.py runserver
```

### 8. Ejecutar MCP Server (opcional, en otra terminal)
```bash
python mcp_server.py
```

### 9. Acceder al Asistente IA
- Inicia sesiÃ³n como Admin
- Ve al menÃº lateral â†’ "Asistente IA"
- Pega texto de correo o sube imagen de SAP
- La IA procesarÃ¡ y crearÃ¡ la solicitud automÃ¡ticamente

---

## ğŸ”§ Archivos Clave Implementados

### Backend

**`solicitudes/models.py`**:
- `Solicitud`: Modelo principal con auto-generaciÃ³n de nÃºmeros ST
- `SolicitudDetalle`: LÃ­neas de producto (hasta 45 por solicitud)
- MÃ©todos helper: `total_codigos()`, `_generar_numero_st()`, etc.

**`solicitudes/services.py`**:
- `crear_solicitud_desde_payload()`: FunciÃ³n centralizada para crear solicitudes desde JSON
- Maneja validaciones, normalizaciÃ³n de datos, creaciÃ³n de detalles
- Reutilizable desde vistas web, API y MCP

**`solicitudes/views.py`**:
- `lista_solicitudes`: Listado con filtros por rol y bÃºsqueda
- `crear_solicitud`: Maneja formulario + formset dinÃ¡mico
- `detalle_solicitud`: Vista detallada con productos
- `api_crear_solicitud_ia`: Endpoint REST para agentes IA

**`ia/gemini_client.py`**:
- `call_gemini_for_solicitud()`: IntegraciÃ³n con Gemini 2.5 Flash
- Procesa texto e imÃ¡genes
- Retorna JSON estructurado para crear solicitudes

**`mcp_server.py`**:
- Servidor MCP standalone
- Expone herramientas: `ping()`, `crear_solicitud()`
- Inicializa Django automÃ¡ticamente

### Frontend

**`frontend_django/templates/components/sidebar.html`**:
- MenÃº dinÃ¡mico segÃºn rol del usuario
- Incluye enlace "Asistente IA" para Admin

**`solicitudes/templates/formulario.html`**:
- Formulario con JavaScript para agregar lÃ­neas dinÃ¡micamente
- Inicia con 5 lÃ­neas, expandible hasta 45

**`solicitudes/templates/lista.html`**:
- Tabla responsiva con columnas optimizadas
- BÃºsqueda por nÃºmero de pedido/ST
- Muestra contador de cÃ³digos por solicitud

### ConfiguraciÃ³n

**`backend/settings.py`**:
- ConfiguraciÃ³n de Gemini (`GEMINI_API_KEY`, `GEMINI_MODEL`)
- Token API para endpoint IA (`IA_API_TOKEN`)
- CORS y REST Framework configurados
- Base de datos configurada (SQLite dev, Supabase pendiente)

---

## ğŸ“Œ PrÃ³ximos pasos

### Fase 1: ConfiguraciÃ³n Inicial âš™ï¸
- [x] Definir estructura de tablas en Supabase  
- [x] Definir roles y flujo de trabajo
- [x] Crear proyecto Django con arquitectura modular  
- [x] Configurar base de datos (SQLite para desarrollo, Supabase pendiente)
- [x] Implementar sistema de autenticaciÃ³n por roles  

### Fase 2: Desarrollo del Core ğŸ—ï¸
- [x] Desarrollar dashboard principal con Bootstrap 5  
- [x] Implementar modelo de Solicitudes con mÃºltiples productos
- [x] Crear formularios de ingreso con validaciÃ³n y formsets dinÃ¡micos
- [x] Aplicar paleta de colores corporativa (azul turquesa)
- [x] Implementar auto-generaciÃ³n de nÃºmeros ST
- [x] Sistema de cambio de rol desde UI (Admin)

### Fase 3: MÃ³dulos Operativos ğŸ“¦ğŸšš
- [ ] Desarrollar mÃ³dulo de Bodega (registro de transferencias)
- [ ] Desarrollar mÃ³dulo de Despacho (embalaje, peso, medidas)
- [ ] Implementar generaciÃ³n de etiquetas de bultos (PDF)
- [ ] Desarrollar mÃ³dulo de GuÃ­as SAP (solo Admin)

### Fase 4: Reportes y Analytics ğŸ“Š
- [ ] Implementar cÃ¡lculo automÃ¡tico de KPIs
- [ ] Crear sistema de exportaciÃ³n de reportes a Excel
- [x] Dashboard con KPIs bÃ¡sicos por rol
- [ ] Configurar carga de stock desde Excel con cachÃ©

### Fase 5: OptimizaciÃ³n y AI ğŸ¤–
- [x] Integrar MCP Server para IA  
- [x] Implementar Asistente IA integrado en web (Gemini 2.5)
- [x] API endpoint para agentes IA externos
- [x] Optimizar queries con Ã­ndices en modelos
- [ ] Implementar sistema de cookies para cachÃ©

### Fase 6: Testing y ProducciÃ³n ğŸš€
- [ ] Probar flujo completo con usuarios internos  
- [x] Ajustes de UX/UI segÃºn feedback (listado, formularios dinÃ¡micos)
- [ ] Configurar conexiÃ³n Supabase en producciÃ³n
- [ ] Deploy en Render (producciÃ³n)  
- [x] DocumentaciÃ³n tÃ©cnica actualizada

---

## ğŸ“‹ Resumen Ejecutivo del Sistema

### ğŸ¯ Problema
Registro manual en Excel genera ineficiencias, duplicidad y errores en la operaciÃ³n logÃ­stica de PESCO.

### ğŸ’¡ SoluciÃ³n
Sistema web Django con Supabase que digitaliza el flujo completo: Solicitud â†’ Bodega â†’ Despacho â†’ GuÃ­a SAP.

### ğŸ‘¥ Usuarios (3 Roles)
1. **Admin**: Acceso total, emite guÃ­as SAP, puede reemplazar cualquier rol
2. **Bodega**: Registra transferencias a despacho
3. **Despacho**: Embala, pesa, mide y genera etiquetas

### ğŸ”„ Flujo Simplificado
```
Admin crea solicitud â†’ Bodega registra transferencia â†’ 
Despacho embala y etiqueta â†’ Admin emite guÃ­a SAP â†’ Despachado âœ…
```

### ğŸ¨ TecnologÃ­as
- **Backend**: Python + Django 5 + Supabase (PostgreSQL) / SQLite (desarrollo)
- **Frontend**: Bootstrap 5 + JavaScript + Django Templates
- **IA**: Gemini 2.5 Flash (`google-generativeai`)
- **Extras**: MCP Server (IA), ReportLab (etiquetas PDF), Pandas (Excel)

### ğŸ“ˆ Beneficios Implementados
- âœ… Trazabilidad completa de solicitudes
- âœ… EliminaciÃ³n de duplicidad de registros
- âœ… **Asistente IA integrado** para procesar correos e imÃ¡genes automÃ¡ticamente
- âœ… **MÃºltiples productos por solicitud** (hasta 45 lÃ­neas)
- âœ… **Auto-generaciÃ³n de nÃºmeros ST** con reinicio anual
- âœ… Dashboard con KPIs por rol
- âœ… Acceso por roles (seguridad)
- âœ… Formularios dinÃ¡micos con JavaScript
- âœ… API REST para integraciones externas

### ğŸ“ˆ Beneficios Pendientes
- â³ KPIs automÃ¡ticos (lead time, dÃ­as en despacho)
- â³ Reportes exportables a Excel
- â³ GeneraciÃ³n automÃ¡tica de etiquetas de bultos

---

## ğŸ“ Contacto y Soporte

**Administrador del Sistema**: [Tu nombre]  
**Email**: admin@pesco.cl  
**Repositorio**: [GitHub del proyecto]  

---

**VersiÃ³n del Documento**: 3.0  
**Ãšltima ActualizaciÃ³n**: Diciembre 2024  
**Estado**: âœ… **MVP en desarrollo activo** - MÃ³dulo de Solicitudes + IA implementado

---

## ğŸ“ Changelog de ImplementaciÃ³n

### VersiÃ³n 3.0 (Diciembre 2024) - MÃ³dulo de Solicitudes + IA
- âœ… Sistema de autenticaciÃ³n con roles (Admin, Bodega, Despacho)
- âœ… Modelo `Solicitud` completo con todos los campos
- âœ… Modelo `SolicitudDetalle` para mÃºltiples productos (hasta 45 lÃ­neas)
- âœ… Auto-generaciÃ³n de nÃºmeros ST (`ST-AAAA-###`) con reinicio anual
- âœ… Formularios dinÃ¡micos con formsets (inicia con 5 lÃ­neas, expandible)
- âœ… Dashboard con KPIs por rol
- âœ… Listado de solicitudes con bÃºsqueda por pedido/ST
- âœ… Vista de detalle de solicitud
- âœ… **Asistente IA integrado** (`/ia/chat/`) con Gemini 2.5 Flash
- âœ… Procesamiento de texto (correos) e imÃ¡genes (capturas SAP)
- âœ… API endpoint para agentes IA externos (`/solicitudes/api/ia/crear/`)
- âœ… MCP Server implementado (`mcp_server.py`)
- âœ… Capa de servicios (`solicitudes/services.py`) para lÃ³gica reutilizable
- âœ… Cambio de rol desde UI (Admin)
- âœ… Templates Bootstrap 5 con diseÃ±o profesional
- âœ… Sistema de migraciones Django configurado

### PrÃ³ximas Funcionalidades
- â³ MÃ³dulo de Bodega (transferencias)
- â³ MÃ³dulo de Despacho (embalaje, etiquetas)
- â³ MÃ³dulo de GuÃ­as SAP
- â³ ExportaciÃ³n de reportes a Excel
- â³ CÃ¡lculo automÃ¡tico de KPIs
- â³ ConexiÃ³n Supabase en producciÃ³n
